This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: App.tsx, index.tsx, components/**, services/**, firebaseConfig.ts, package.json, package-lock.json, apphosting.yaml, firebase.json, server.js, README.md
- Files matching these patterns are excluded: **/node_modules/**, **/dist/**, **/.git/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
components/
  AreaManager.tsx
  Dashboard.tsx
  EvidenceDashboard.tsx
  Layout.tsx
  Login.tsx
  PlantManager.tsx
  RequirementsManager.tsx
  StandardManager.tsx
  StandardView.tsx
  SystemSettings.tsx
  UserManagement.tsx
services/
  dataService.test.ts
  dataService.ts
App.tsx
apphosting.yaml
firebase.json
firebaseConfig.ts
index.tsx
package.json
README.md
server.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="components/AreaManager.tsx">
import React, { useState } from 'react';
import { Area, User } from '../types';
import { Users, Plus, Trash2, Edit2, X, Briefcase, Save, UserCircle, AlertCircle, ExternalLink } from 'lucide-react';

interface AreaManagerProps {
  areas: Area[];
  users: User[];
  onAdd: (area: Area) => void;
  onUpdate: (area: Area) => void;
  onDelete: (id: string) => void;
}

export const AreaManager: React.FC<AreaManagerProps> = ({ areas, users, onAdd, onUpdate, onDelete }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingArea, setEditingArea] = useState<Area | null>(null);
  const [formData, setFormData] = useState<Partial<Area>>({
    name: '',
    description: ''
  });

  const handleOpenModal = (area?: Area) => {
    if (area) {
      setEditingArea(area);
      setFormData({ name: area.name, description: area.description });
    } else {
      setEditingArea(null);
      setFormData({ name: '', description: '' });
    }
    setIsModalOpen(true);
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.name?.trim()) return;

    if (editingArea) {
      onUpdate({
        ...editingArea,
        name: formData.name.trim(),
        description: formData.description?.trim() || ''
      });
    } else {
      const areaData: Area = {
        id: `area-${Date.now()}`,
        name: formData.name.trim(),
        description: formData.description?.trim() || ''
      };
      onAdd(areaData);
    }

    setFormData({ name: '', description: '' });
    setIsModalOpen(false);
  };

  const getUsersInArea = (areaName: string) => {
    return users.filter(u => u.assignedArea === areaName);
  };

  const handleForceDelete = (e: React.MouseEvent, id: string, name: string) => {
    e.preventDefault();
    e.stopPropagation();
    if (window.confirm(`驴Desea eliminar definitivamente el 谩rea "${name.toUpperCase()}"?`)) {
      onDelete(id);
    }
  };

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-top-4 duration-500">
      {/* Header Compacto Pro */}
      <div className="flex items-center justify-between bg-white px-8 py-5 rounded-[2rem] shadow-sm border border-slate-200">
        <div className="flex items-center gap-4">
          <div className="p-3 bg-slate-900 text-white rounded-2xl shadow-xl">
            <Briefcase size={24} />
          </div>
          <div>
            <h2 className="text-2xl font-black text-slate-800 tracking-tight uppercase">Dependencias</h2>
            <div className="flex items-center gap-2">
              <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
              <p className="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">{areas.length} reas Configuradas</p>
            </div>
          </div>
        </div>
        <button 
          onClick={() => handleOpenModal()}
          className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl flex items-center shadow-lg shadow-blue-100 text-xs font-black uppercase tracking-widest transition-all active:scale-95 group"
        >
          <Plus size={18} className="mr-2 group-hover:rotate-90 transition-transform" />
          Nueva Dependencia
        </button>
      </div>

      {/* Grid de Tarjetas Optimizadas */}
      <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {areas.map((area) => {
          const areaUsers = getUsersInArea(area.name);
          return (
            <div 
              key={area.id} 
              className="bg-white rounded-[2rem] border-2 border-slate-100 flex flex-col hover:border-blue-500 hover:shadow-2xl transition-all duration-300 group relative overflow-hidden h-fit"
            >
              {/* Acciones Superiores - Siempre Visibles */}
              <div className="absolute top-4 right-4 flex gap-2 z-30">
                <button 
                  onClick={() => handleOpenModal(area)}
                  className="p-2.5 bg-slate-50 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all border border-slate-100 hover:border-blue-200 shadow-sm"
                  title="Editar"
                >
                  <Edit2 size={16} />
                </button>
                <button 
                  onClick={(e) => handleForceDelete(e, area.id, area.name)} 
                  className="p-2.5 bg-slate-50 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all border border-slate-100 hover:border-red-200 shadow-sm"
                  title="Eliminar"
                >
                  <Trash2 size={16} />
                </button>
              </div>

              <div className="p-6 pb-4">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                    <Briefcase size={20} />
                  </div>
                  <h3 className="text-sm font-black text-slate-900 uppercase tracking-tight pr-20 truncate">
                    {area.name}
                  </h3>
                </div>

                <p className="text-[11px] text-slate-500 font-medium leading-relaxed italic line-clamp-2 h-[2.5rem] mb-4">
                  {area.description || 'Sin descripci贸n de responsabilidades cargada.'}
                </p>

                <div className="pt-4 border-t border-slate-50">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <Users size={14} className="text-slate-400" />
                      <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Equipo Responsable</span>
                    </div>
                    <span className="text-[10px] font-black text-blue-600 bg-blue-50 px-2.5 py-1 rounded-full">{areaUsers.length}</span>
                  </div>

                  {/* Listado de integrantes con nombres visibles */}
                  <div className="flex flex-wrap gap-2 max-h-[80px] overflow-y-auto scrollbar-thin">
                    {areaUsers.length > 0 ? (
                      areaUsers.map(user => (
                        <div key={user.id} className="flex items-center bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-100 group/user hover:border-blue-200 transition-all">
                          <UserCircle size={14} className="text-slate-300 mr-2 group-hover/user:text-blue-500" />
                          <span className="text-[10px] font-bold text-slate-600 group-hover/user:text-slate-900">{user.name}</span>
                        </div>
                      ))
                    ) : (
                      <div className="flex items-center text-[10px] text-slate-400 font-bold italic p-3 bg-slate-50/50 w-full justify-center rounded-xl border border-dashed border-slate-200">
                        <AlertCircle size={12} className="mr-2" />
                        Sin personal asignado
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Bot贸n Detalles Funcional */}
              <button 
                onClick={() => handleOpenModal(area)}
                className="w-full py-4 bg-slate-50 hover:bg-blue-600 text-slate-400 hover:text-white text-[10px] font-black uppercase tracking-[0.2em] transition-all flex items-center justify-center gap-2 border-t border-slate-100"
              >
                <ExternalLink size={14} />
                Ver Detalles Completos
              </button>
            </div>
          );
        })}
      </div>

      {/* Modal Redise帽ado */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[6000] p-4 backdrop-blur-md animate-in fade-in duration-300">
          <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg animate-in zoom-in-95 duration-300 border border-slate-200 overflow-hidden">
            <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
              <div className="flex items-center gap-4">
                <div className="p-3 bg-slate-900 text-white rounded-2xl shadow-xl">
                  {editingArea ? <Edit2 size={20} /> : <Plus size={20} />}
                </div>
                <div>
                  <h3 className="text-lg font-black text-slate-900 tracking-tight uppercase">
                    {editingArea ? 'Actualizar rea' : 'Nuevo Registro'}
                  </h3>
                  <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Gesti贸n Organizacional</p>
                </div>
              </div>
              <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-900 transition-colors p-2 hover:bg-slate-100 rounded-full">
                <X size={28} />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="p-8 space-y-6">
              <div className="space-y-2">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Nombre del rea / Proceso</label>
                <input 
                  required 
                  type="text" 
                  value={formData.name} 
                  onChange={e => setFormData({...formData, name: e.target.value})} 
                  className="w-full px-5 py-4 border-2 border-slate-100 rounded-2xl text-sm font-black bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none shadow-inner" 
                  placeholder="Ej: TALENTO HUMANO" 
                />
              </div>

              <div className="space-y-2">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] ml-1">Descripci贸n de Responsabilidades</label>
                <textarea 
                  rows={4} 
                  value={formData.description} 
                  onChange={e => setFormData({...formData, description: e.target.value})} 
                  className="w-full border-2 border-slate-100 rounded-2xl p-5 text-sm font-medium bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none resize-none shadow-inner" 
                  placeholder="Defina el alcance de este departamento..." 
                />
              </div>

              <div className="flex gap-3 pt-4">
                <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-4 text-slate-400 font-black text-xs uppercase tracking-widest hover:bg-slate-50 rounded-2xl transition-all">
                  Cancelar
                </button>
                <button type="submit" className="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl shadow-blue-200 hover:bg-blue-700 transition-all flex items-center justify-center active:scale-95">
                  <Save size={18} className="mr-2" />
                  Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="services/dataService.test.ts">
import { describe, it, expect } from 'vitest';
import { dataService } from './dataService';

describe('DataService Logic', () => {
  it('should always include MOSQUERA in plantIds even if empty', () => {
    // Fix: Removed unused @ts-expect-error and cast to any to access private method for testing
    const result = (dataService as any).cleanPlantIds([]);
    expect(result).toContain('MOSQUERA');
  });

  it('should normalize plant IDs to uppercase and trim spaces', () => {
    // Fix: Removed unused @ts-expect-error and cast to any to access private method for testing
    const result = (dataService as any).cleanPlantIds([' plt-cali ', 'mosquera']);
    expect(result).toEqual(['PLT-CALI', 'MOSQUERA']);
  });

  it('should handle undefined or null plantIds gracefully', () => {
    // Fix: Removed unused @ts-expect-error and cast to any to access private method for testing
    const result = (dataService as any).cleanPlantIds(undefined);
    expect(result).toEqual(['MOSQUERA']);
  });
});
</file>

<file path="components/PlantManager.tsx">
import React, { useState } from 'react';
import { Plant } from '../types';
import { 
  Factory, Plus, Edit2, Trash2, X, MapPin, Building2, 
  Save, MapPinned, Info, ArrowRight, Home
} from 'lucide-react';

interface PlantManagerProps {
  plants: Plant[];
  onAdd: (plant: Plant) => void;
  onUpdate: (plant: Plant) => void;
  onDelete: (id: string) => void;
}

export const PlantManager: React.FC<PlantManagerProps> = ({ plants, onAdd, onUpdate, onDelete }) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingPlant, setEditingPlant] = useState<Plant | null>(null);
  const [formData, setFormData] = useState<Partial<Plant>>({
    name: '',
    location: '',
    isMain: false,
    description: ''
  });

  const handleOpenModal = (plant?: Plant) => {
    if (plant) {
      setEditingPlant(plant);
      setFormData(plant);
    } else {
      setEditingPlant(null);
      setFormData({ name: '', location: '', isMain: false, description: '' });
    }
    setIsModalOpen(true);
  };

  const handleDelete = (e: React.MouseEvent, id: string, name: string) => {
    e.preventDefault();
    e.stopPropagation(); // CRITICO: Evita que el click active la tarjeta completa
    if (window.confirm(`驴Est谩 seguro que desea eliminar la planta "${name.toUpperCase()}"?`)) {
      onDelete(id);
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.name?.trim()) return;

    const plantData: Plant = {
      id: editingPlant ? editingPlant.id : `PLT-${Date.now()}`,
      name: formData.name.trim(),
      location: formData.location || '',
      isMain: formData.isMain || false,
      description: formData.description || ''
    };

    if (editingPlant) onUpdate(plantData);
    else onAdd(plantData);
    
    setIsModalOpen(false);
  };

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-top-4 duration-500">
      <div className="flex items-center justify-between bg-white px-8 py-5 rounded-[2.5rem] shadow-sm border border-slate-200">
        <div className="flex items-center gap-4">
          <div className="p-3 bg-red-600 text-white rounded-2xl shadow-xl shadow-red-100">
            <Factory size={24} />
          </div>
          <div>
            <h2 className="text-2xl font-black text-slate-800 tracking-tight uppercase">Plantas y Sedes</h2>
            <div className="flex items-center gap-2">
              <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
              <p className="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">{plants.length} Ubicaciones</p>
            </div>
          </div>
        </div>
        <button 
          onClick={() => handleOpenModal()}
          className="bg-slate-900 hover:bg-black text-white px-8 py-4 rounded-2xl flex items-center shadow-lg text-xs font-black uppercase tracking-widest transition-all active:scale-95"
        >
          <Plus size={18} className="mr-2" />
          Nueva Planta
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {plants.map((plant) => (
          <div 
            key={plant.id} 
            className={`bg-white rounded-[2.5rem] border-2 flex flex-col hover:shadow-2xl transition-all duration-300 relative overflow-hidden h-fit ${
              plant.isMain ? 'border-red-100' : 'border-slate-100'
            }`}
          >
            <div className="absolute top-6 right-6 flex gap-2 z-30">
              <button 
                onClick={() => handleOpenModal(plant)}
                className="p-2.5 bg-white/80 backdrop-blur-sm text-slate-400 hover:text-blue-600 rounded-xl transition-all border border-slate-100 shadow-sm"
              >
                <Edit2 size={16} />
              </button>
              <button 
                onClick={(e) => handleDelete(e, plant.id, plant.name)} 
                className="p-2.5 bg-white/80 backdrop-blur-sm text-slate-400 hover:text-red-600 rounded-xl transition-all border border-slate-100 shadow-sm"
              >
                <Trash2 size={16} />
              </button>
            </div>

            <div className="p-8">
              <div className="flex items-center gap-4 mb-6">
                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${
                  plant.isMain ? 'bg-red-600 text-white shadow-lg' : 'bg-slate-50 text-slate-400'
                }`}>
                  {plant.isMain ? <Home size={24} /> : <MapPinned size={24} />}
                </div>
                <div>
                  <h3 className="text-base font-black text-slate-900 uppercase tracking-tight pr-16 truncate">
                    {plant.name}
                  </h3>
                  {plant.isMain && (
                    <span className="text-[8px] font-black text-red-600 bg-red-50 px-2 py-0.5 rounded border border-red-100 uppercase tracking-widest mt-1 inline-block">Sede Matriz</span>
                  )}
                </div>
              </div>

              <div className="space-y-4">
                <div className="flex items-start gap-3">
                  <MapPin size={16} className="text-slate-400 mt-0.5" />
                  <div>
                    <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Localizaci贸n</p>
                    <p className="text-xs font-bold text-slate-700">{plant.location}</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <Info size={16} className="text-slate-400 mt-0.5" />
                  <div>
                    <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Descripci贸n</p>
                    <p className="text-xs text-slate-500 font-medium italic line-clamp-2">
                      {plant.description || 'Sin descripci贸n.'}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <button 
              onClick={() => handleOpenModal(plant)}
              className="w-full py-4 bg-slate-50 hover:bg-slate-900 text-slate-400 hover:text-white text-[10px] font-black uppercase tracking-[0.2em] transition-all flex items-center justify-center gap-2 border-t border-slate-100"
            >
              Configurar Planta
              <ArrowRight size={14} />
            </button>
          </div>
        ))}
      </div>

      {isModalOpen && (
        <div className="fixed inset-0 bg-slate-950/80 flex items-center justify-center z-[6000] p-4 backdrop-blur-md animate-in fade-in duration-300">
          <div className="bg-white rounded-[3rem] shadow-2xl w-full max-w-lg animate-in zoom-in-95 duration-300 border border-slate-200 overflow-hidden">
            <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
              <div className="flex items-center gap-4">
                <div className="p-4 bg-slate-900 text-white rounded-3xl shadow-xl">
                  {editingPlant ? <Edit2 size={24} /> : <Plus size={24} />}
                </div>
                <div>
                  <h3 className="text-xl font-black text-slate-900 tracking-tight uppercase">
                    {editingPlant ? 'Editar Planta' : 'Nueva Planta'}
                  </h3>
                  <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Infraestructura Corporativa</p>
                </div>
              </div>
              <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-900 transition-colors p-2 hover:bg-slate-100 rounded-full">
                <X size={32} />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="p-8 space-y-6">
              <div className="space-y-2">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Nombre de la Sede</label>
                <div className="relative">
                  <Building2 size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                  <input 
                    required 
                    type="text" 
                    value={formData.name} 
                    onChange={e => setFormData({...formData, name: e.target.value})} 
                    className="w-full pl-12 pr-6 py-4 border-2 border-slate-100 rounded-2xl text-sm font-black bg-slate-50 focus:bg-white focus:border-red-600 transition-all outline-none" 
                    placeholder="Ej: PLANTA MOSQUERA" 
                  />
                </div>
              </div>

              <div className="space-y-2">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Ubicaci贸n</label>
                <div className="relative">
                  <MapPin size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                  <input 
                    required 
                    type="text" 
                    value={formData.location} 
                    onChange={e => setFormData({...formData, location: e.target.value})} 
                    className="w-full pl-12 pr-6 py-4 border-2 border-slate-100 rounded-2xl text-sm font-black bg-slate-50 focus:bg-white focus:border-red-600 transition-all outline-none" 
                    placeholder="Ej: Cundinamarca, Colombia" 
                  />
                </div>
              </div>

              <div className="space-y-2">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Descripci贸n</label>
                <textarea 
                  rows={3} 
                  value={formData.description} 
                  onChange={e => setFormData({...formData, description: e.target.value})} 
                  className="w-full border-2 border-slate-100 rounded-2xl p-5 text-sm font-medium bg-slate-50 focus:bg-white focus:border-red-600 transition-all outline-none resize-none" 
                  placeholder="Detalles sobre el proceso..." 
                />
              </div>

              <div className="flex items-center bg-red-50/50 p-5 rounded-3xl border border-red-100">
                <input 
                  id="isMain"
                  type="checkbox" 
                  checked={formData.isMain} 
                  onChange={e => setFormData({...formData, isMain: e.target.checked})} 
                  className="w-6 h-6 rounded-lg border-red-200 text-red-600 focus:ring-red-500"
                />
                <label htmlFor="isMain" className="ml-4 text-[11px] font-black text-red-900 uppercase tracking-tight">
                  Establecer como Sede Matriz Principal
                </label>
              </div>

              <div className="flex gap-4 pt-4">
                <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-5 text-slate-400 font-black text-xs uppercase tracking-widest">Cancelar</button>
                <button type="submit" className="flex-[2] py-5 bg-slate-900 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl hover:bg-black transition-all">
                  <Save size={20} className="mr-3" /> GUARDAR
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="components/StandardManager.tsx">
import React, { useState } from 'react';
import { StandardDefinition, StandardType, User, UserRole } from '../types';
import { Book, Shield, TreePine, Save, MessageSquare, Plus, Clock, X, Briefcase } from 'lucide-react';
import { dataService } from '../services/dataService';

interface StandardManagerProps {
  standards: StandardDefinition[];
  onUpdateStandard: (std: StandardDefinition) => void;
  currentUser: User;
}

export const StandardManager: React.FC<StandardManagerProps> = ({ standards, onUpdateStandard, currentUser }) => {
  const [selectedStandard, setSelectedStandard] = useState<string>(StandardType.ISO9001);
  const [newComment, setNewComment] = useState('');
  const [isNewStandardModalOpen, setIsNewStandardModalOpen] = useState(false);
  const [newStandardForm, setNewStandardForm] = useState({
    type: '',
    description: '',
    objective: '',
    certifyingBody: ''
  });

  // Combine fixed enums with custom ones from DB
  const standardTypes = Array.from(new Set([
    ...Object.values(StandardType),
    ...standards.map(s => s.type)
  ]));

  const currentDef = standards.find(s => s.type === selectedStandard) || {
    id: `std-${Date.now()}`,
    type: selectedStandard,
    description: '',
    objective: '',
    certifyingBody: '',
    comments: []
  };

  const [formData, setFormData] = useState<StandardDefinition>(currentDef);

  React.useEffect(() => {
    const found = standards.find(s => s.type === selectedStandard);
    if (found) {
      setFormData(found);
    } else {
      setFormData({
        id: `std-${selectedStandard.replace(/\s/g, '').toLowerCase()}`,
        type: selectedStandard,
        description: '',
        objective: '',
        certifyingBody: '',
        comments: []
      });
    }
  }, [selectedStandard, standards]);

  const handleSaveInfo = () => {
    onUpdateStandard(formData);
    alert('Informaci贸n de la norma actualizada.');
  };

  const handleAddComment = () => {
    if (!newComment.trim()) return;

    const comment = {
      id: `cmt-${Date.now()}`,
      text: newComment,
      author: currentUser.name,
      date: new Date().toLocaleString()
    };

    const updated = {
      ...formData,
      comments: [comment, ...formData.comments]
    };

    onUpdateStandard(updated);
    setNewComment('');
  };

  const handleAddNewStandard = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!newStandardForm.type.trim()) return;

    const newStd: StandardDefinition = {
      id: `std-${Date.now()}`,
      type: newStandardForm.type,
      description: newStandardForm.description,
      objective: newStandardForm.objective,
      certifyingBody: newStandardForm.certifyingBody,
      comments: []
    };

    await dataService.addStandard(newStd);
    setSelectedStandard(newStd.type);
    setIsNewStandardModalOpen(false);
    setNewStandardForm({ type: '', description: '', objective: '', certifyingBody: '' });
  };

  const getIcon = (type: string) => {
    if (type === StandardType.ISO9001) return <Book className="mr-2" size={20} />;
    if (type === StandardType.SGSST) return <Shield className="mr-2" size={20} />;
    if (type === StandardType.FSC) return <TreePine className="mr-2" size={20} />;
    return <Briefcase className="mr-2" size={20} />;
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">Gesti贸n de Normas</h2>
          <p className="text-slate-500">Administre la definici贸n, alcance y seguimiento de cada est谩ndar.</p>
        </div>
        {currentUser.role === UserRole.ADMIN && (
          <button 
            onClick={() => setIsNewStandardModalOpen(true)}
            className="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center shadow-sm transition-colors text-sm font-bold"
          >
            <Plus size={18} className="mr-2" />
            A帽adir Norma
          </button>
        )}
      </div>

      {/* Tabs */}
      <div className="flex space-x-2 border-b border-slate-200 overflow-x-auto scrollbar-thin">
        {standardTypes.map(std => (
          <button
            key={std}
            onClick={() => setSelectedStandard(std)}
            className={`px-4 py-3 text-sm font-bold flex items-center transition-all border-b-2 whitespace-nowrap ${
              selectedStandard === std 
                ? 'border-blue-600 text-blue-700 bg-blue-50/50' 
                : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'
            }`}
          >
            {getIcon(std)}
            {std}
          </button>
        ))}
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Info Column */}
        <div className="space-y-4">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center">
              Informaci贸n General
            </h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-1">Descripci贸n de la Norma</label>
                <textarea 
                  rows={4}
                  className="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                  value={formData.description}
                  onChange={e => setFormData({...formData, description: e.target.value})}
                  placeholder="Describa el alcance de la norma..."
                />
              </div>

              <div>
                <label className="block text-sm font-bold text-slate-700 mb-1">Objetivo General</label>
                <textarea 
                  rows={3}
                  className="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                  value={formData.objective}
                  onChange={e => setFormData({...formData, objective: e.target.value})}
                  placeholder="驴Cu谩l es la meta principal?"
                />
              </div>

              <div>
                <label className="block text-sm font-bold text-slate-700 mb-1">Ente Certificador / Auditor</label>
                <input 
                  type="text"
                  className="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                  value={formData.certifyingBody}
                  onChange={e => setFormData({...formData, certifyingBody: e.target.value})}
                  placeholder="Ej. ICONTEC, SGS, Bureau Veritas..."
                />
              </div>

              <div className="pt-2">
                <button 
                  onClick={handleSaveInfo}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center hover:bg-blue-700 transition-colors shadow-sm"
                >
                  <Save size={16} className="mr-2" />
                  Guardar Informaci贸n
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* Comments / Log Column */}
        <div className="space-y-4">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center">
              <MessageSquare className="mr-2 text-slate-500" size={20} />
              Bit谩cora de Avance
            </h3>

            <div className="flex-1 overflow-y-auto max-h-[400px] space-y-4 mb-4 pr-2 scrollbar-thin">
              {formData.comments.length > 0 ? (
                formData.comments.map(comment => (
                  <div key={comment.id} className="bg-slate-50 p-3 rounded-lg border border-slate-100 shadow-sm hover:border-slate-200 transition-colors">
                    <div className="flex justify-between items-start mb-1">
                      <span className="font-bold text-sm text-slate-700">{comment.author}</span>
                      <span className="text-xs text-slate-400 flex items-center">
                        <Clock size={10} className="mr-1" />
                        {comment.date}
                      </span>
                    </div>
                    <p className="text-sm text-slate-600 leading-relaxed">{comment.text}</p>
                  </div>
                ))
              ) : (
                <div className="text-center text-slate-400 py-10 italic">
                  No hay comentarios registrados para esta norma.
                </div>
              )}
            </div>

            <div className="pt-4 border-t border-slate-100">
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Nuevo Comentario</label>
              <div className="flex gap-2">
                <input 
                  type="text" 
                  value={newComment}
                  onChange={e => setNewComment(e.target.value)}
                  className="flex-1 border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                  placeholder="Escriba un reporte de avance..."
                  onKeyDown={e => e.key === 'Enter' && handleAddComment()}
                />
                <button 
                  onClick={handleAddComment}
                  className="bg-slate-800 text-white p-2 rounded-lg hover:bg-slate-900 transition-colors shadow-md"
                >
                  <Plus size={20} />
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* NEW STANDARD MODAL */}
      {isNewStandardModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[80] p-4 backdrop-blur-sm">
           <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200">
              <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                 <h3 className="text-xl font-bold text-slate-800 flex items-center">
                   <Plus className="mr-2 text-blue-600" /> A帽adir Nueva Norma
                 </h3>
                 <button onClick={() => setIsNewStandardModalOpen(false)} className="text-slate-400 hover:text-slate-600"><X size={24} /></button>
              </div>
              <form onSubmit={handleAddNewStandard} className="p-6 space-y-4">
                 <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">Nombre / Identificador de la Norma</label>
                    <input 
                      required
                      type="text" 
                      value={newStandardForm.type}
                      onChange={e => setNewStandardForm({...newStandardForm, type: e.target.value})}
                      className="w-full border border-slate-300 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="Ej: ISO 14001:2015"
                    />
                 </div>
                 <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">Ente Certificador</label>
                    <input 
                      type="text" 
                      value={newStandardForm.certifyingBody}
                      onChange={e => setNewStandardForm({...newStandardForm, certifyingBody: e.target.value})}
                      className="w-full border border-slate-300 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="Ej: ICONTEC"
                    />
                 </div>
                 <div>
                    <label className="block text-sm font-bold text-slate-700 mb-1">Descripci贸n</label>
                    <textarea 
                      rows={3}
                      value={newStandardForm.description}
                      onChange={e => setNewStandardForm({...newStandardForm, description: e.target.value})}
                      className="w-full border border-slate-300 rounded-xl p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="Describa brevemente el alcance..."
                    />
                 </div>
                 <div className="flex gap-3 pt-4 border-t border-slate-100 mt-2">
                    <button type="button" onClick={() => setIsNewStandardModalOpen(false)} className="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-50 rounded-xl">Cancelar</button>
                    <button type="submit" className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition-all">Crear Norma</button>
                 </div>
              </form>
           </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="README.md">
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1GM_gEd7UTLiGP475uzCXPBW1Mv6quuRa

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`
</file>

<file path="firebase.json">
{
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
</file>

<file path="server.js">
import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 8080;

// Servir archivos est谩ticos de la carpeta dist generada por el build
app.use(express.static(path.join(__dirname, 'dist')));

// Ruta de salud para el balanceador de carga de Google
app.get('/health', (req, res) => res.status(200).send('OK'));

// Redirecci贸n SPA: Cualquier ruta que no sea un archivo va al index.html
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

app.listen(PORT, () => {
  console.log(` Servidor listo en puerto ${PORT}`);
});
</file>

<file path="components/EvidenceDashboard.tsx">
import React, { useState, useMemo } from 'react';
import { Activity, User, MonthlyExecution } from '../types';
import { MONTHS } from '../constants';
import { AlertCircle, CheckCircle, Clock, ExternalLink, RefreshCw, Search, ShieldAlert, ThumbsUp } from 'lucide-react';

interface EvidenceDashboardProps {
  activities: Activity[];
  currentUser: User;
  onUpdateActivity: (activity: Activity) => void;
}

interface EvidenceItem {
  activity: Activity;
  monthIndex: number;
  plan: MonthlyExecution;
  year: number;
}

export const EvidenceDashboard: React.FC<EvidenceDashboardProps> = ({ activities, currentUser, onUpdateActivity }) => {
  const [filter, setFilter] = useState<'ALL' | 'REJECTED' | 'PENDING' | 'APPROVED'>('REJECTED');

  // Helper to extract unique evidence entries from an activity across all possible storage locations
  const getUniqueEvidenceItems = (activity: Activity): EvidenceItem[] => {
    const uniqueItems: Map<string, EvidenceItem> = new Map();

    // 1. Process 'plans' (the most modern and structured storage)
    if (activity.plans) {
      Object.entries(activity.plans).forEach(([yearStr, monthPlans]) => {
        const year = parseInt(yearStr);
        (monthPlans as MonthlyExecution[]).forEach((plan, monthIndex) => {
          if (plan.evidence) {
            const key = `${year}-${monthIndex}`;
            uniqueItems.set(key, { activity, monthIndex, plan, year });
          }
        });
      });
    }

    // 2. Process legacy 'monthlyPlan' (assumed to be 2025 if not present in plans)
    if (Array.isArray(activity.monthlyPlan)) {
      activity.monthlyPlan.forEach((plan, monthIndex) => {
        if (plan.evidence) {
          const key = `2025-${monthIndex}`;
          // Only add if not already present from the structured 'plans' for 2025
          if (!uniqueItems.has(key)) {
            uniqueItems.set(key, { activity, monthIndex, plan, year: 2025 });
          }
        }
      });
    }

    return Array.from(uniqueItems.values());
  };

  // Memoize all unique items for performance and consistency
  const allUniqueItems = useMemo(() => {
    return activities.flatMap(a => getUniqueEvidenceItems(a));
  }, [activities]);

  const filteredIssues = useMemo(() => {
    return allUniqueItems.filter(item => {
      const status = item.plan.evidence?.status || 'PENDING';
      if (filter === 'ALL') return true;
      if (filter === 'REJECTED') return status === 'REJECTED';
      if (filter === 'PENDING') return status === 'PENDING';
      if (filter === 'APPROVED') return status === 'APPROVED';
      return false;
    }).sort((a, b) => {
      const dateA = a.plan.evidence?.rejectionDate || a.plan.evidence?.uploadedAt || '';
      const dateB = b.plan.evidence?.rejectionDate || b.plan.evidence?.uploadedAt || '';
      return new Date(dateB).getTime() - new Date(dateA).getTime();
    });
  }, [allUniqueItems, filter]);

  const getDaysOpen = (dateString?: string) => {
    if (!dateString) return 0;
    const start = new Date(dateString).getTime();
    const now = new Date().getTime();
    return Math.floor((now - start) / (1000 * 60 * 60 * 24));
  };

  const countByStatus = (status: 'REJECTED' | 'PENDING' | 'APPROVED') => {
    return allUniqueItems.filter(item => {
       const s = item.plan.evidence?.status || (item.plan.evidence ? 'PENDING' : '');
       return s === status;
    }).length;
  };

  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h2 className="text-2xl font-black text-slate-800 tracking-tight">Control de Hallazgos y Evidencias</h2>
          <p className="text-slate-500 font-medium">Gesti贸n de no conformidades documentales y validaciones del sistema.</p>
        </div>
        <div className="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm flex-wrap">
           <button 
             onClick={() => setFilter('REJECTED')}
             className={`px-4 py-2 text-xs font-black rounded-lg transition-all ${filter === 'REJECTED' ? 'bg-orange-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
           >
             Rechazadas
           </button>
           <button 
             onClick={() => setFilter('PENDING')}
             className={`px-4 py-2 text-xs font-black rounded-lg transition-all ${filter === 'PENDING' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
           >
             Por Verificar
           </button>
           <button 
             onClick={() => setFilter('APPROVED')}
             className={`px-4 py-2 text-xs font-black rounded-lg transition-all ${filter === 'APPROVED' ? 'bg-green-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
           >
             Aprobadas
           </button>
           <button 
             onClick={() => setFilter('ALL')}
             className={`px-4 py-2 text-xs font-black rounded-lg transition-all ${filter === 'ALL' ? 'bg-slate-800 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}
           >
             Todo el Historial
           </button>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-sm border-2 border-orange-50 relative overflow-hidden group">
           <div className="absolute top-0 left-0 w-1.5 h-full bg-orange-500"></div>
           <div className="flex justify-between items-start relative z-10">
             <div>
               <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Evidencias Rechazadas</p>
               <h3 className="text-3xl font-black text-orange-600">{countByStatus('REJECTED')}</h3>
             </div>
             <div className="p-3 bg-orange-50 rounded-xl text-orange-500 group-hover:scale-110 transition-transform"><ShieldAlert size={24}/></div>
           </div>
           <p className="text-[10px] text-slate-500 mt-4 font-bold flex items-center">
             <AlertCircle size={12} className="mr-1.5" /> Requieren correcci贸n inmediata
           </p>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border-2 border-blue-50 relative overflow-hidden group">
           <div className="absolute top-0 left-0 w-1.5 h-full bg-blue-500"></div>
           <div className="flex justify-between items-start relative z-10">
             <div>
               <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Por Verificar (Pendientes)</p>
               <h3 className="text-3xl font-black text-blue-600">{countByStatus('PENDING')}</h3>
             </div>
             <div className="p-3 bg-blue-50 rounded-xl text-blue-500 group-hover:scale-110 transition-transform"><Clock size={24}/></div>
           </div>
           <p className="text-[10px] text-slate-500 mt-4 font-bold flex items-center">
             <RefreshCw size={12} className="mr-1.5" /> Pendientes de aprobaci贸n auditora
           </p>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border-2 border-green-50 relative overflow-hidden group">
           <div className="absolute top-0 left-0 w-1.5 h-full bg-green-500"></div>
           <div className="flex justify-between items-start relative z-10">
             <div>
               <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Aprobadas (Total)</p>
               <h3 className="text-3xl font-black text-green-600">{countByStatus('APPROVED')}</h3>
             </div>
             <div className="p-3 bg-green-50 rounded-xl text-green-500 group-hover:scale-110 transition-transform"><CheckCircle size={24}/></div>
           </div>
           <p className="text-[10px] text-slate-500 mt-4 font-bold flex items-center">
             <ThumbsUp size={12} className="mr-1.5" /> Cumplimiento total validado
           </p>
        </div>
      </div>

      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-left border-collapse">
            <thead className="bg-slate-50 text-slate-400 font-black uppercase text-[10px] tracking-[0.2em] border-b border-slate-100">
              <tr>
                <th className="p-5">Estado</th>
                <th className="p-5">Requisito / Actividad</th>
                <th className="p-5">Periodo</th>
                <th className="p-5">Responsable</th>
                <th className="p-5">Detalle / Nota Admin</th>
                <th className="p-5 text-center">Gesti贸n</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {filteredIssues.map((item) => {
                const status = item.plan.evidence?.status || 'PENDING';
                const daysOpen = getDaysOpen(item.plan.evidence?.rejectionDate);
                
                return (
                  <tr key={`${item.activity.id}-${item.year}-${item.monthIndex}`} className="hover:bg-slate-50/80 transition-all group">
                    <td className="p-5">
                      <div className="flex flex-col gap-1.5">
                        {status === 'REJECTED' && (
                          <span className="inline-flex items-center w-fit px-3 py-1 rounded-full text-[9px] font-black bg-orange-100 text-orange-800 border border-orange-200 uppercase tracking-wider">
                            <AlertCircle size={10} className="mr-1.5" />
                            Rechazado
                          </span>
                        )}
                        {status === 'PENDING' && (
                           <span className="inline-flex items-center w-fit px-3 py-1 rounded-full text-[9px] font-black bg-blue-100 text-blue-800 border border-blue-200 uppercase tracking-wider">
                            <Clock size={10} className="mr-1.5" />
                            Por Verificar
                          </span>
                        )}
                        {status === 'APPROVED' && (
                           <span className="inline-flex items-center w-fit px-3 py-1 rounded-full text-[9px] font-black bg-green-100 text-green-800 border border-green-200 uppercase tracking-wider">
                            <CheckCircle size={10} className="mr-1.5" />
                            Aprobado
                          </span>
                        )}
                        {status === 'REJECTED' && (
                          <div className="text-[9px] text-orange-600 font-black uppercase flex items-center">
                            <Clock size={10} className="mr-1" />
                            {daysOpen === 0 ? 'Hoy' : `${daysOpen} d铆as abierto`}
                          </div>
                        )}
                      </div>
                    </td>
                    <td className="p-5">
                      <div className="font-black text-slate-800 text-xs">{item.activity.clause} {item.activity.clauseTitle}</div>
                      <div className="text-[10px] text-slate-400 truncate max-w-[200px] mt-1 font-medium">{item.activity.relatedQuestions}</div>
                    </td>
                    <td className="p-5">
                      <div className="font-black text-slate-700 text-xs">
                        {MONTHS[item.monthIndex]} <span className="text-slate-400 font-bold">{item.year}</span>
                      </div>
                    </td>
                    <td className="p-5">
                      <div className="text-xs font-black text-slate-700">{item.plan.evidence?.uploadedBy}</div>
                      <span className="text-[9px] font-black px-2 py-0.5 bg-slate-100 rounded-md text-slate-500 border border-slate-200 uppercase tracking-tighter inline-block mt-1">
                        {item.activity.responsibleArea}
                      </span>
                    </td>
                    <td className="p-5">
                       {status === 'REJECTED' ? (
                         <div className="bg-orange-50/50 p-3 rounded-xl border border-orange-100/50 text-[10px] text-orange-950 font-medium">
                           <strong className="uppercase font-black block mb-1 tracking-widest text-[8px]">Motivo del Rechazo:</strong>
                           {item.plan.evidence?.adminComment || 'Sin comentario detallado'}
                         </div>
                       ) : status === 'APPROVED' ? (
                         <div className="bg-green-50/50 p-3 rounded-xl border border-green-100/50 text-[10px] text-green-950 font-medium">
                           <div className="flex items-center mb-1">
                             <ThumbsUp size={12} className="mr-1.5 text-green-600" />
                             <span className="font-black uppercase tracking-widest text-[8px]">Validado por {item.plan.evidence?.approvedBy || 'Admin'}</span>
                           </div>
                           {item.plan.evidence?.adminComment && <p className="opacity-80 italic">"{item.plan.evidence.adminComment}"</p>}
                         </div>
                       ) : (
                         <div className="text-[10px] text-slate-400 font-bold italic flex items-center">
                           <RefreshCw size={12} className="mr-2 animate-spin-slow text-blue-500" />
                           Esperando revisi贸n administrativa...
                         </div>
                       )}
                    </td>
                    <td className="p-5 text-center">
                       <button 
                        onClick={() => {
                           if (item.plan.evidence?.type === 'LINK') {
                             window.open(item.plan.evidence.url, '_blank');
                           } else {
                             const link = document.createElement("a");
                             link.href = item.plan.evidence!.url;
                             link.download = item.plan.evidence!.fileName;
                             document.body.appendChild(link);
                             link.click();
                             document.body.removeChild(link);
                           }
                        }}
                        className="inline-flex items-center text-blue-600 hover:text-white text-[10px] font-black uppercase bg-blue-50 hover:bg-blue-600 px-4 py-2 rounded-xl border border-blue-100 transition-all shadow-sm active:scale-95"
                      >
                         <ExternalLink size={14} className="mr-2" /> Ver Evidencia
                       </button>
                    </td>
                  </tr>
                );
              })}
              {filteredIssues.length === 0 && (
                <tr>
                  <td colSpan={6} className="p-20 text-center">
                    <div className="flex flex-col items-center">
                      <div className="p-5 bg-slate-50 rounded-full mb-4">
                        <CheckCircle size={48} className="text-slate-200" />
                      </div>
                      <p className="text-sm font-black text-slate-400 uppercase tracking-widest">Sin registros encontrados</p>
                      <button 
                        onClick={() => setFilter('ALL')}
                        className="mt-6 text-blue-600 text-xs font-black hover:bg-blue-50 px-6 py-3 rounded-xl border border-blue-100 transition-all uppercase tracking-widest"
                      >
                        Ver todo el historial
                      </button>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="components/Login.tsx">
import React, { useState } from 'react';
import { Lock, User, RefreshCw, AlertTriangle } from 'lucide-react';
import { User as UserType } from '../types';
import { MOCK_USERS } from '../constants';

interface LoginProps {
  onLogin: (user: UserType) => void;
  companyLogo?: string | null;
  users: UserType[]; // Receive the current list of users from App state
}

export const Login: React.FC<LoginProps> = ({ onLogin, companyLogo, users }) => {
  const [email, setEmail] = useState('admin@centralmaderas.com');
  const [password, setPassword] = useState('123');
  const [error, setError] = useState('');
  
  // Helper: Normalizaci贸n agresiva (Nuclea cualquier espacio, tabulaci贸n o salto de l铆nea)
  const normalize = (str: string) => {
    return String(str || '').replace(/\s+/g, '').toLowerCase().trim();
  };

  const handleLogin = (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    
    // Clean inputs aggressively
    const cleanInputEmail = normalize(email);
    const cleanInputPass = String(password).trim(); 

    // 1. Intentar validar con los usuarios de la DB
    let user = users.find(u => {
      const dbEmail = normalize(u.email);
      const dbPass = String(u.password || '').trim();
      return dbEmail === cleanInputEmail && dbPass === cleanInputPass;
    });
    
    // 2. FALLBACK DE EMERGENCIA (BOOTSTRAP):
    if (!user && users.length === 0) {
       user = MOCK_USERS.find(u => 
         normalize(u.email) === cleanInputEmail && 
         u.password === cleanInputPass
       );
    }
    
    if (user) {
      onLogin(user);
    } else {
      // Diagn贸stico espec铆fico para el error (mantenemos el mensaje detallado aunque quitamos la lista visual)
      const emailExists = users.some(u => normalize(u.email) === cleanInputEmail);
      
      if (!emailExists) {
        setError('El correo NO coincide con ning煤n usuario registrado.');
      } else {
        setError('Correo encontrado, pero la CONTRASEA es incorrecta.');
      }
    }
  };

  // Prevent typing spaces in email
  const handleEmailChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value.replace(/\s/g, '');
    setEmail(val);
  };

  const isDatabaseLoading = users.length === 0;

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 relative overflow-hidden">
      {/* Background Decorative Element */}
      <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-slate-100 to-slate-200"></div>
      <div className="absolute right-0 top-0 w-1/2 h-full bg-red-700 opacity-5 transform skew-x-[-10deg] translate-x-20"></div>

      <div className="bg-white rounded-2xl shadow-xl p-10 w-full max-w-md relative z-10 border border-slate-200">
        <div className="text-center mb-10">
          <div className="flex justify-center mb-6 h-24 items-center">
            {companyLogo ? (
              <img src={companyLogo} alt="Logo Empresa" className="max-h-full max-w-full object-contain" />
            ) : (
              /* Custom SVG Logo for Central de Maderas */
              <svg viewBox="0 0 320 100" className="h-24 w-auto">
                <g strokeLinecap="round" strokeLinejoin="round" fill="none">
                  <path d="M 20 70 L 45 35 L 70 70" stroke="#B91C1C" strokeWidth="10" />
                  <path d="M 45 70 L 70 35 L 95 70" stroke="#1F2937" strokeWidth="10" />
                  <path d="M 70 70 L 95 35 L 120 70" stroke="#B91C1C" strokeWidth="10" />
                  <rect x="88" y="60" width="14" height="14" transform="rotate(45 95 67)" fill="#1F2937" stroke="none" />
                </g>
                <g fontFamily="sans-serif">
                  <text x="135" y="65" fontSize="24" fontWeight="800" fill="#1F2937">Central de Maderas</text>
                  <text x="180" y="88" fontSize="18" fontWeight="500" fill="#4B5563" letterSpacing="0.05em">G&S SAS</text>
                </g>
              </svg>
            )}
          </div>
          <h2 className="text-2xl font-bold text-slate-800">Bienvenido</h2>
          <p className="text-slate-500 mt-2">Sistema Integrado de Gesti贸n (SIG)</p>
        </div>

        <form onSubmit={handleLogin} className="space-y-6">
          {error && (
            <div className="bg-red-50 text-red-700 p-4 rounded-xl text-sm text-center border border-red-100 font-medium animate-pulse flex items-center justify-center">
              <AlertTriangle size={18} className="mr-2 flex-shrink-0" />
              {error}
            </div>
          )}
          
          {/* Status Indicator */}
          <div className={`text-xs text-center p-1 rounded ${isDatabaseLoading ? 'text-amber-600 bg-amber-50' : 'text-green-600 bg-green-50'}`}>
             {isDatabaseLoading 
               ? "Conectando con el servidor..." 
               : "Sistema en l铆nea y seguro"}
          </div>
          
          <div>
            <label className="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Correo Electr贸nico</label>
            <div className="relative group">
              <User className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-red-600 transition-colors" size={20} />
              <input 
                type="email" 
                value={email}
                onChange={handleEmailChange}
                className="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-600 focus:border-red-600 outline-none transition-all bg-slate-50 focus:bg-white"
                placeholder="usuario@centralmaderas.com"
              />
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Contrase帽a</label>
            <div className="relative group">
              <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 group-focus-within:text-red-600 transition-colors" size={20} />
              <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-600 focus:border-red-600 outline-none transition-all bg-slate-50 focus:bg-white"
                placeholder="⑩⑩⑩⑩⑩⑩⑩"
              />
            </div>
          </div>

          <button 
            type="submit" 
            disabled={isDatabaseLoading && !error} 
            className={`w-full font-bold py-3.5 rounded-xl transition-all shadow-lg transform flex items-center justify-center
              ${isDatabaseLoading 
                ? 'bg-slate-300 text-slate-500 cursor-not-allowed' 
                : 'bg-gradient-to-r from-red-700 to-red-600 hover:from-red-800 hover:to-red-700 text-white hover:shadow-red-700/30 hover:-translate-y-0.5'
              }`}
          >
            {isDatabaseLoading ? (
               <>
                 <RefreshCw className="animate-spin mr-2" size={18} />
                 Sincronizando...
               </>
            ) : (
               "INGRESAR"
            )}
          </button>
        </form>

        <div className="mt-8 pt-6 border-t border-slate-100 text-center">
          <p className="text-xs text-slate-400">
            漏 2025 Central de Maderas G&S SAS<br/>
            Gesti贸n de Calidad, Seguridad y Medio Ambiente
          </p>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="components/UserManagement.tsx">
import React, { useState } from 'react';
import { User, UserRole, NotificationSettings, Area } from '../types';
import { Plus, Trash2, User as UserIcon, Shield, Briefcase, Edit, Save, X, Bell, Mail, ToggleLeft, ToggleRight, MapPin } from 'lucide-react';

interface UserManagementProps {
  users: User[];
  areas: Area[];
  onAddUser: (user: User) => void;
  onUpdateUser: (user: User) => void;
  onDeleteUser: (id: string) => void;
}

export const UserManagement: React.FC<UserManagementProps> = ({ users, areas, onAddUser, onUpdateUser, onDeleteUser }) => {
  const [editingId, setEditingId] = useState<string | null>(null);
  
  const defaultNotifs: NotificationSettings = {
    notifyOnRejection: true,
    notifyOnApproval: true,
    notifyOnNewUpload: true,
    emailEnabled: true
  };

  const [formData, setFormData] = useState({
    name: '',
    email: '',
    role: UserRole.LEADER,
    assignedArea: areas.length > 0 ? areas[0].name : '',
    password: '',
    notifications: defaultNotifs
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    const sanitizedData = {
      ...formData,
      email: formData.email.trim().toLowerCase(),
      password: formData.password.trim()
    };
    
    if (editingId) {
      onUpdateUser({
        id: editingId,
        ...sanitizedData
      });
      setEditingId(null);
    } else {
      onAddUser({
        id: `u-${Date.now()}`,
        ...sanitizedData
      });
    }
    
    setFormData({ name: '', email: '', role: UserRole.LEADER, assignedArea: areas.length > 0 ? areas[0].name : '', password: '', notifications: defaultNotifs });
  };

  const handleEdit = (user: User) => {
    setEditingId(user.id);
    setFormData({
      name: user.name,
      email: user.email,
      role: user.role,
      assignedArea: user.assignedArea || (areas.length > 0 ? areas[0].name : ''),
      password: user.password || '',
      notifications: user.notifications || defaultNotifs
    });
  };

  const handleCancelEdit = () => {
    setEditingId(null);
    setFormData({ name: '', email: '', role: UserRole.LEADER, assignedArea: areas.length > 0 ? areas[0].name : '', password: '', notifications: defaultNotifs });
  };

  const toggleNotif = (key: keyof NotificationSettings) => {
    setFormData({
      ...formData,
      notifications: {
        ...formData.notifications,
        [key]: !formData.notifications[key]
      }
    });
  };

  return (
    <div className="space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-slate-800">Perfil y Gesti贸n de Usuarios</h2>
        <p className="text-slate-500">Administre el acceso del personal y vinc煤lelos a sus procesos correspondientes.</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-1">
          <div className={`p-6 rounded-xl shadow-sm border transition-colors ${editingId ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-200'}`}>
            <div className="flex justify-between items-center mb-4">
              <h3 className={`text-lg font-bold ${editingId ? 'text-blue-800' : 'text-slate-800'}`}>
                {editingId ? 'Editar Perfil / Usuario' : 'Nuevo Usuario'}
              </h3>
              {editingId && (
                <button onClick={handleCancelEdit} className="text-slate-400 hover:text-slate-600"><X size={20} /></button>
              )}
            </div>
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                <input required type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Correo Electr贸nico</label>
                <input required type="email" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Rol</label>
                  <select value={formData.role} onChange={e => setFormData({...formData, role: e.target.value as UserRole})} className="w-full border border-slate-300 rounded-lg p-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                    <option value={UserRole.LEADER}>L铆der</option>
                    <option value={UserRole.ADMIN}>Admin</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold text-slate-500 uppercase mb-1">rea / Proceso</label>
                  <select value={formData.assignedArea} onChange={e => setFormData({...formData, assignedArea: e.target.value})} className="w-full border border-slate-300 rounded-lg p-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                    {areas.map(a => <option key={a.id} value={a.name}>{a.name}</option>)}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Contrase帽a</label>
                <input required type="text" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} className="w-full border border-slate-300 rounded-lg p-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>

              <div className="pt-4 border-t border-slate-200">
                <h4 className="text-xs font-bold text-slate-700 flex items-center mb-4 uppercase tracking-wider">
                  <Bell size={14} className="mr-2 text-blue-600" /> Preferencias de Notificaci贸n
                </h4>
                <div className="space-y-3">
                  <button type="button" onClick={() => toggleNotif('notifyOnRejection')} className="flex items-center justify-between w-full p-2 hover:bg-black/5 rounded transition-colors group">
                    <span className="text-xs text-slate-600 font-medium">Rechazo de Evidencia</span>
                    {formData.notifications.notifyOnRejection ? <ToggleRight className="text-blue-600" /> : <ToggleLeft className="text-slate-300" />}
                  </button>
                  <button type="button" onClick={() => toggleNotif('notifyOnApproval')} className="flex items-center justify-between w-full p-2 hover:bg-black/5 rounded transition-colors group">
                    <span className="text-xs text-slate-600 font-medium">Aprobaci贸n de Evidencia</span>
                    {formData.notifications.notifyOnApproval ? <ToggleRight className="text-blue-600" /> : <ToggleLeft className="text-slate-300" />}
                  </button>
                  {formData.role === UserRole.ADMIN && (
                    <button type="button" onClick={() => toggleNotif('notifyOnNewUpload')} className="flex items-center justify-between w-full p-2 hover:bg-black/5 rounded transition-colors group">
                      <span className="text-xs text-slate-600 font-medium">Nuevas Cargas (Admin)</span>
                      {formData.notifications.notifyOnNewUpload ? <ToggleRight className="text-blue-600" /> : <ToggleLeft className="text-slate-300" />}
                    </button>
                  )}
                  <button type="button" onClick={() => toggleNotif('emailEnabled')} className="flex items-center justify-between w-full p-2 mt-2 bg-slate-100 rounded-lg group">
                    <span className="text-xs text-slate-700 font-bold flex items-center">
                      <Mail size={12} className="mr-2" /> Alertar por Correo
                    </span>
                    {formData.notifications.emailEnabled ? <ToggleRight className="text-green-600" /> : <ToggleLeft className="text-slate-400" />}
                  </button>
                </div>
              </div>
              
              <div className="flex gap-2 pt-2">
                <button type="submit" className={`flex-1 ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-800 hover:bg-slate-900'} text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center shadow-lg`}>
                  {editingId ? <Save size={18} className="mr-2" /> : <Plus size={18} className="mr-2" />}
                  {editingId ? 'Actualizar' : 'Crear'}
                </button>
              </div>
            </form>
          </div>
        </div>

        <div className="lg:col-span-2">
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <table className="w-full text-sm text-left">
              <thead className="bg-slate-100 text-slate-600 font-semibold uppercase text-xs tracking-wider">
                <tr>
                  <th className="p-4">Usuario</th>
                  <th className="p-4">rea</th>
                  <th className="p-4">Rol</th>
                  <th className="p-4 text-center">Acciones</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-200">
                {users.map((user) => (
                  <tr key={user.id} className={`hover:bg-slate-50 transition-colors ${editingId === user.id ? 'bg-blue-50/50' : ''}`}>
                    <td className="p-4">
                      <div className="flex items-center space-x-3">
                        <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600">
                          <UserIcon size={16} />
                        </div>
                        <div>
                          <div className="font-bold text-slate-900">{user.name}</div>
                          <div className="text-xs text-slate-500">{user.email}</div>
                        </div>
                      </div>
                    </td>
                    <td className="p-4">
                      <div className="flex items-center text-slate-600 font-bold text-xs uppercase">
                        <MapPin size={12} className="mr-1.5 text-slate-400" />
                        {user.assignedArea || 'Global'}
                      </div>
                    </td>
                    <td className="p-4">
                      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-black uppercase tracking-wider ${
                        user.role === UserRole.ADMIN ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'
                      }`}>
                        {user.role}
                      </span>
                    </td>
                    <td className="p-4 text-center">
                      <div className="flex items-center justify-center space-x-2">
                        <button onClick={() => handleEdit(user)} className="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-2 rounded-full transition-colors"><Edit size={18} /></button>
                        <button onClick={() => onDeleteUser(user.id)} className="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-full transition-colors"><Trash2 size={18} /></button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="components/Dashboard.tsx">
import React, { useMemo } from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
  PieChart, Pie, Cell, ComposedChart, Area as AreaChart, Line
} from 'recharts';
import { 
  TrendingDown, TrendingUp, AlertTriangle, CheckCircle2, 
  ClipboardList, ShieldCheck, Factory, Target, Info
} from 'lucide-react';
import { Activity, Area, Plant, MonthlyExecution } from '../types';
import { MONTHS } from '../constants';

interface DashboardProps {
  activities: Activity[];
  areas: Area[];
  plants: Plant[];
  currentYear: number;
}

const COLORS = ['#1e293b', '#b91c1c', '#2563eb', '#059669', '#d97706', '#7c3aed'];

const KPICard = ({ title, value, subtext, icon: Icon, trend, colorClass }: any) => (
  <div className="bg-white p-3 rounded-[1.2rem] shadow-sm border border-slate-100 flex items-center justify-between transition-all hover:shadow-md">
    <div>
      <p className="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-0.5">{title}</p>
      <h3 className="text-xl font-black text-slate-900 tracking-tight">{value}</h3>
      <div className={`flex items-center mt-0.5 text-[7px] font-black uppercase tracking-wider ${trend === 'up' ? 'text-green-600' : 'text-red-600'}`}>
        {trend === 'up' ? <TrendingUp size={10} className="mr-1" /> : <TrendingDown size={10} className="mr-1" />}
        {subtext}
      </div>
    </div>
    <div className={`p-2 rounded-xl ${colorClass}`}>
      <Icon size={16} />
    </div>
  </div>
);

export const Dashboard: React.FC<DashboardProps> = ({ activities, areas, plants, currentYear }) => {
  const currentMonth = new Date().getMonth();

  const stats = useMemo(() => {
    let totalPlanned = 0;
    let totalApproved = 0;
    let criticalCount = 0;

    const areaMap: Record<string, any> = {};
    const normMap: Record<string, any> = {};
    const plantDataMap: Record<string, { planned: number; approved: number }> = {};
    const monthlyData = MONTHS.map(m => ({ month: m, plan: 0, real: 0 }));

    plants.forEach(p => {
      plantDataMap[p.id.toUpperCase()] = { planned: 0, approved: 0 };
    });

    activities.forEach(activity => {
      const plan = activity.plans?.[currentYear] || [];
      if (!areaMap[activity.responsibleArea]) {
        areaMap[activity.responsibleArea] = { name: activity.responsibleArea, planned: 0, approved: 0 };
      }
      activity.standards.forEach(std => {
        if (!normMap[std]) normMap[std] = { name: std, planned: 0, approved: 0 };
      });
      plan.forEach((m: MonthlyExecution, idx: number) => {
        if (m.planned) {
          totalPlanned++;
          areaMap[activity.responsibleArea].planned++;
          activity.standards.forEach(std => normMap[std].planned++);
          activity.plantIds.forEach(pid => {
            const normalizedId = pid.toUpperCase();
            if (plantDataMap[normalizedId]) plantDataMap[normalizedId].planned++;
          });
          monthlyData[idx].plan++;
          if (m.evidence?.status === 'APPROVED') {
            totalApproved++;
            areaMap[activity.responsibleArea].approved++;
            activity.standards.forEach(std => normMap[std].approved++);
            activity.plantIds.forEach(pid => {
              const normalizedId = pid.toUpperCase();
              if (plantDataMap[normalizedId]) plantDataMap[normalizedId].approved++;
            });
            monthlyData[idx].real++;
          } else if (idx <= currentMonth) {
            criticalCount++;
          }
        }
      });
    });

    const areaStats = Object.values(areaMap).map((a: any) => ({
      name: a.name,
      cumplimiento: a.planned > 0 ? Math.round((a.approved / a.planned) * 100) : 0
    })).sort((a, b) => b.cumplimiento - a.cumplimiento);

    const normStats = Object.values(normMap).map((n: any) => ({
      name: n.name.split(' ')[0], 
      value: n.planned > 0 ? Math.round((n.approved / n.planned) * 100) : 0
    }));

    const plantStats = plants.map(p => {
      const data = plantDataMap[p.id.toUpperCase()] || { planned: 0, approved: 0 };
      return {
        name: p.name,
        cumplimiento: data.planned > 0 ? Math.round((data.approved / data.planned) * 100) : 0,
        isMain: p.isMain
      };
    }).sort((a, b) => b.cumplimiento - a.cumplimiento);

    const compliance = totalPlanned > 0 ? Math.round((totalApproved / totalPlanned) * 100) : 0;
    const deterioration = Math.max(0, 100 - compliance);

    return { compliance, criticalCount, deterioration, evidenceTotal: `${totalApproved}/${totalPlanned}`, areaStats, normStats, plantStats, monthlyData };
  }, [activities, plants, currentMonth, currentYear]);

  return (
    <div className="flex flex-col gap-3 h-[calc(100vh-100px)] overflow-hidden">
      {/* Resumen de Auditoria - Compacto */}
      <div className="bg-slate-900 text-white p-4 rounded-[1.5rem] shadow-xl relative overflow-hidden border-l-[8px] border-red-600 shrink-0">
        <div className="relative z-10">
          <div className="flex items-center mb-1">
            <div className="bg-red-600 p-1 rounded-lg mr-3">
              <ShieldCheck size={16} className="text-white" />
            </div>
            <h2 className="text-sm font-black tracking-tight uppercase">Resumen de Auditor铆a Interna {currentYear}</h2>
            <span className="ml-3 px-2 py-0.5 bg-red-600 text-[7px] font-black rounded-full uppercase tracking-widest animate-pulse">Prioritario</span>
          </div>
          <p className="text-slate-400 max-w-5xl leading-tight text-[11px] font-medium italic">
            Bienvenido al panel integral de <strong className="text-white">Central de Maderas</strong>. Actualmente, el cumplimiento global del a帽o <span className="text-white font-black">{currentYear}</span> es del <span className="text-white font-black text-lg">{stats.compliance}%</span>. 
          </p>
        </div>
        <div className="absolute right-0 top-0 h-full w-1/4 bg-gradient-to-l from-red-600/10 to-transparent skew-x-12 translate-x-20"></div>
      </div>

      {/* KPI Row - Compacto */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 shrink-0">
        <KPICard title="Cumplimiento Global" value={`${stats.compliance}%`} subtext="+5.2% vs mes anterior" icon={CheckCircle2} trend="up" colorClass="bg-green-50 text-green-600" />
        <KPICard title="Actividades Cr铆ticas" value={stats.criticalCount} subtext="Revisar vencimientos" icon={AlertTriangle} trend="down" colorClass="bg-red-50 text-red-600" />
        <KPICard title="Deterioro del Sistema" value={`${stats.deterioration}%`} subtext="Vs L铆nea Base" icon={TrendingDown} trend="down" colorClass="bg-orange-50 text-orange-600" />
        <KPICard title="Evidencias Cargadas" value={stats.evidenceTotal} subtext="En proceso" icon={ClipboardList} trend="up" colorClass="bg-blue-50 text-blue-600" />
      </div>

      {/* Main Charts Grid - Expandido */}
      <div className="grid grid-cols-12 gap-3 flex-1 min-h-0">
        <div className="col-span-12 lg:col-span-7 bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-200 flex flex-col min-h-0">
          <div className="flex items-center justify-between mb-3 shrink-0">
            <h3 className="text-[10px] font-black text-slate-800 flex items-center uppercase tracking-widest">
              <div className="w-1 h-4 bg-red-600 rounded-full mr-2"></div>
              Cumplimiento por rea
            </h3>
          </div>
          <div className="flex-1 min-h-0">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={stats.areaStats} layout="vertical" margin={{ left: 5, right: 30 }}>
                <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                <XAxis type="number" domain={[0, 100]} hide />
                <YAxis dataKey="name" type="category" width={80} stroke="#475569" fontSize={8} fontWeight={900} />
                <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{borderRadius: '8px', border: 'none', fontSize: '10px'}} />
                <Bar dataKey="cumplimiento" name="Cumplimiento %" radius={[0, 4, 4, 0]} barSize={12}>
                  {stats.areaStats.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.cumplimiento < 80 ? '#ef4444' : '#22c55e'} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="col-span-12 lg:col-span-5 bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-200 flex flex-col min-h-0">
          <h3 className="text-[10px] font-black text-slate-800 mb-3 flex items-center uppercase tracking-widest shrink-0">
            <div className="w-1 h-4 bg-slate-800 rounded-full mr-2"></div>
            Evoluci贸n y Deterioro
          </h3>
          <div className="flex-1 min-h-0">
            <ResponsiveContainer width="100%" height="100%">
              <ComposedChart data={stats.monthlyData.slice(0, 6)}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                <XAxis dataKey="month" stroke="#94a3b8" fontSize={8} fontWeight={700} />
                <YAxis stroke="#94a3b8" fontSize={8} fontWeight={700} />
                <Tooltip contentStyle={{borderRadius: '8px', border: 'none', fontSize: '10px'}} />
                <Legend iconType="circle" wrapperStyle={{fontSize: '8px', fontWeight: 900}} />
                <AreaChart type="monotone" dataKey="plan" name="Planificado" fill="#f1f5f9" stroke="#cbd5e1" />
                <Line type="monotone" dataKey="real" name="Ejecutado" stroke="#b91c1c" strokeWidth={2} dot={{r: 3, fill: '#b91c1c'}} />
              </ComposedChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="col-span-12 lg:col-span-4 bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-200 flex flex-col min-h-0">
          <h3 className="text-[10px] font-black text-slate-800 mb-2 flex items-center uppercase tracking-widest shrink-0">
            <Target size={12} className="mr-2 text-blue-600" />
            Por Norma
          </h3>
          <div className="flex-1 min-h-0">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie data={stats.normStats} innerRadius={35} outerRadius={50} paddingAngle={5} dataKey="value" nameKey="name">
                  {stats.normStats.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip />
                <Legend layout="horizontal" verticalAlign="bottom" align="center" wrapperStyle={{fontSize: '7px', fontWeight: 900}} />
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="col-span-12 lg:col-span-8 bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-200 flex flex-col min-h-0">
          <h3 className="text-[10px] font-black text-slate-800 mb-2 flex items-center uppercase tracking-widest shrink-0">
            <Factory size={12} className="mr-2 text-red-600" />
            Rendimiento por Planta
          </h3>
          <div className="flex-1 min-h-0">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={stats.plantStats} margin={{bottom: 10}}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                <XAxis dataKey="name" stroke="#94a3b8" fontSize={8} fontWeight={900} />
                <YAxis hide domain={[0, 100]} />
                <Tooltip cursor={{fill: 'transparent'}} />
                <Bar dataKey="cumplimiento" name="Cumplimiento %" radius={[4, 4, 0, 0]} barSize={24}>
                   {stats.plantStats.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.isMain ? '#ef4444' : entry.cumplimiento < 70 ? '#f59e0b' : '#3b82f6'} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="index.tsx">
// SIG-Manager Pro v1.6.8 - Cloud Deployment Ready
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
</file>

<file path="components/SystemSettings.tsx">
import React, { useRef, useState, useEffect } from 'react';
import { 
  Upload, Image as ImageIcon, Save, CheckCircle, Database, 
  CloudLightning, AlertTriangle, RefreshCw, Trash2, Search, 
  ShieldCheck, Activity as ActivityIcon, Code, Terminal 
} from 'lucide-react';
import { dataService } from '../services/dataService';
import { USE_CLOUD_DB, firebaseConfig } from '../firebaseConfig';
import { collection, getCountFromServer } from 'firebase/firestore';
import { db } from '../firebaseConfig';

interface SystemSettingsProps {
  currentLogo: string | null;
  onLogoChange: (logo: string | null) => void;
}

export const SystemSettings: React.FC<SystemSettingsProps> = ({ currentLogo, onLogoChange }) => {
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [preview, setPreview] = useState<string | null>(currentLogo);
  const [message, setMessage] = useState<string | null>(null);
  const [isSyncing, setIsSyncing] = useState(false);
  const [dbStats, setDbStats] = useState<{activities: number, users: number} | null>(null);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (!file.type.match('image.*')) {
        setMessage('Por favor seleccione un archivo de imagen v喔｀lido (JPG, PNG).');
        return;
      }
      
      const reader = new FileReader();
      reader.onloadend = () => {
        const result = reader.result as string;
        setPreview(result);
        setMessage(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSave = async () => {
    if (preview) {
      await dataService.updateSettings({ companyLogo: preview });
      onLogoChange(preview);
      setMessage('Logo actualizado correctamente.');
      setTimeout(() => setMessage(null), 3000);
    }
  };

  const handleVerifyData = async () => {
    if (!USE_CLOUD_DB || !db) return;
    setIsSyncing(true);
    try {
      const collActivities = collection(db, 'activities');
      const collUsers = collection(db, 'users');
      const snapshotAct = await getCountFromServer(collActivities);
      const snapshotUsers = await getCountFromServer(collUsers);
      setDbStats({
        activities: snapshotAct.data().count,
        users: snapshotUsers.data().count
      });
      setMessage('Diagn喔｀stico completado.');
    } catch (error: any) {
      setMessage(`Error: ${error.message}`);
    } finally {
      setIsSyncing(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-8 pb-10">
      <div className="flex justify-between items-end">
        <div>
          <h2 className="text-2xl font-black text-slate-800 tracking-tight">Configuraci喔｀n y Auditor喔｀a</h2>
          <p className="text-slate-500 font-medium">Gesti喔｀n de infraestructura y monitorizaci喔｀n de integridad.</p>
        </div>
        <div className="flex items-center space-x-2 bg-green-50 px-4 py-2 rounded-full border border-green-200">
          <ShieldCheck size={16} className="text-green-600" />
          <span className="text-[10px] font-black text-green-700 uppercase tracking-widest">Build Protected</span>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Integridad de C喔｀digo */}
        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
          <h3 className="text-sm font-black text-slate-800 mb-4 flex items-center uppercase tracking-wider">
            <Code className="mr-2 text-blue-500" size={18} />
            Estado de Integridad
          </h3>
          <div className="space-y-3">
            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
              <div className="flex items-center">
                <Terminal size={14} className="mr-3 text-slate-400" />
                <span className="text-xs font-bold text-slate-600 uppercase">Type-Check (TSC)</span>
              </div>
              <span className="text-[10px] font-black bg-green-100 text-green-700 px-2 py-0.5 rounded border border-green-200 uppercase">Passed</span>
            </div>
            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
              <div className="flex items-center">
                <ActivityIcon size={14} className="mr-3 text-slate-400" />
                <span className="text-xs font-bold text-slate-600 uppercase">Unit Tests (Vitest)</span>
              </div>
              <span className="text-[10px] font-black bg-green-100 text-green-700 px-2 py-0.5 rounded border border-green-200 uppercase">Passed</span>
            </div>
            <div className="p-3 bg-blue-50 rounded-xl border border-blue-100 mt-4">
              <p className="text-[10px] text-blue-800 font-medium leading-relaxed">
                <strong>Docker Guard:</strong> El proceso de build fallar喔｀ autom喔｀ticamente si se detectan regresiones en la l喔｀gica o errores de tipado.
              </p>
            </div>
          </div>
        </div>

        {/* Estado de la Nube */}
        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
          <h3 className="text-sm font-black text-slate-800 mb-4 flex items-center uppercase tracking-wider">
            <Database className="mr-2 text-red-600" size={18} />
            Conexi喔｀n de Datos
          </h3>
          <div className="space-y-4">
            <div className={`p-4 rounded-xl border flex items-center gap-3 ${USE_CLOUD_DB ? 'bg-green-50 border-green-100' : 'bg-amber-50 border-amber-100'}`}>
              {USE_CLOUD_DB ? <CloudLightning className="text-green-600" /> : <AlertTriangle className="text-amber-600" />}
              <div>
                <h4 className="text-xs font-black text-slate-800 uppercase tracking-tight">Firebase Cloud</h4>
                <p className="text-[10px] text-slate-500 font-medium">{firebaseConfig.projectId} (Activo)</p>
              </div>
            </div>
            <div className="flex gap-2">
              <button 
                onClick={handleVerifyData}
                disabled={isSyncing}
                className="flex-1 py-2.5 bg-slate-800 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-black transition-all flex items-center justify-center"
              >
                <RefreshCw size={14} className={`mr-2 ${isSyncing ? 'animate-spin' : ''}`} />
                Verificar Sincronizaci喔｀n
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Gesti喔｀n de Logo */}
      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
        <h3 className="text-sm font-black text-slate-800 mb-6 flex items-center uppercase tracking-wider">
          <ImageIcon className="mr-2 text-slate-400" size={18} />
          Identidad Visual de la Empresa
        </h3>
        <div className="flex flex-col md:flex-row gap-8 items-center">
          <div className="w-full md:w-1/2 bg-slate-50 rounded-2xl p-10 border-2 border-dashed border-slate-200 flex items-center justify-center">
            {preview ? (
              <img src={preview} alt="Preview" className="max-h-32 object-contain" />
            ) : (
              <div className="text-center">
                <ImageIcon size={48} className="mx-auto text-slate-200 mb-2" />
                <p className="text-xs text-slate-400 font-bold uppercase tracking-tight">Sin Logo Cargado</p>
              </div>
            )}
          </div>
          <div className="w-full md:w-1/2 space-y-4">
            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
            <button onClick={() => fileInputRef.current?.click()} className="w-full py-4 border-2 border-slate-200 text-slate-600 rounded-2xl flex items-center justify-center font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition-all">
              <Upload size={18} className="mr-2" /> Seleccionar Archivo
            </button>
            <div className="flex gap-3">
              <button onClick={handleSave} disabled={!preview || preview === currentLogo} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-blue-200 disabled:opacity-50">Guardar Logo</button>
              <button onClick={() => { setPreview(null); onLogoChange(null); }} className="px-6 py-4 border border-slate-200 text-slate-400 rounded-2xl text-[10px] font-black uppercase">Restaurar</button>
            </div>
          </div>
        </div>
        {message && <div className="mt-6 p-4 bg-blue-50 text-blue-700 rounded-xl text-xs font-black flex items-center border border-blue-100 animate-in fade-in"><CheckCircle size={16} className="mr-2" />{message}</div>}
      </div>
    </div>
  );
};
</file>

<file path="components/Layout.tsx">
import React, { useState, useEffect } from 'react';
import { 
  LayoutDashboard, 
  FileText, 
  ShieldCheck, 
  TreePine, 
  Menu, 
  Bell, 
  UserCircle,
  Settings,
  Users,
  LogOut,
  Sliders,
  CloudLightning,
  HardDrive,
  BookOpen,
  AlertOctagon,
  X,
  Check,
  Mail,
  BellRing,
  Trash2,
  Clock,
  Briefcase,
  ChevronDown,
  ChevronUp,
  Shield,
  Truck,
  Factory,
  Layers
} from 'lucide-react';
import { User, UserRole, Notification, StandardDefinition } from '../types';
import { dataService } from '../services/dataService';

interface LayoutProps {
  children: React.ReactNode;
  activeView: string;
  setActiveView: (view: string) => void;
  currentUser: User;
  onLogout: () => void;
  companyLogo?: string | null;
  isCloudConnected?: boolean;
  standards: StandardDefinition[];
}

export const Layout: React.FC<LayoutProps> = ({ 
  children, 
  activeView, 
  setActiveView, 
  currentUser, 
  onLogout, 
  companyLogo,
  isCloudConnected = false,
  standards
}) => {
  const [isSidebarOpen, setIsSidebarOpen] = useState(typeof window !== 'undefined' ? window.innerWidth >= 1024 : false);
  const [isNotifOpen, setIsNotifOpen] = useState(false);
  const [isAdminExpanded, setIsAdminExpanded] = useState(false);
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);

  useEffect(() => {
    const unsub = dataService.subscribeToNotifications(currentUser.id, (data) => {
      setNotifications(data);
      setUnreadCount(data.filter(n => !n.read).length);
    });
    return () => unsub();
  }, [currentUser.id]);

  const handleMarkRead = async (notif: Notification) => {
    if (!notif.read) {
      await dataService.markNotificationAsRead(notif.id, currentUser.id);
    }
  };

  const getStandardIcon = (type: string) => {
    const t = type.toLowerCase();
    if (t.includes('9001')) return FileText;
    if (t.includes('sst')) return ShieldCheck;
    if (t.includes('fsc')) return TreePine;
    if (t.includes('vial') || t.includes('pesv')) return Truck;
    return Briefcase;
  };

  // Filtrar normas duplicadas por su tipo para el men煤
  const uniqueStandards = standards.filter((std, index, self) =>
    index === self.findIndex((t) => t.type === std.type)
  );

  const mainItems = [
    { id: 'dashboard', label: 'Tablero de Control', icon: LayoutDashboard },
    ...uniqueStandards.map(std => ({
      id: `std-${std.type}`,
      label: std.type,
      icon: getStandardIcon(std.type)
    }))
  ];

  const managementItems = [
     { id: 'evidence-dashboard', label: 'Hallazgos y Evidencias', icon: AlertOctagon },
  ];

  const adminItems = [
    { id: 'norms', label: 'Gesti贸n de Normas', icon: BookOpen },
    { id: 'requirements', label: 'Requisitos y Matriz', icon: Settings },
    { id: 'plants', label: 'Gesti贸n de Plantas', icon: Factory },
    { id: 'areas', label: 'Gesti贸n de reas', icon: Layers },
    { id: 'users', label: 'Usuarios', icon: Users },
    { id: 'settings', label: 'Configuraci贸n Global', icon: Sliders },
  ];

  const isAdmin = currentUser.role === UserRole.ADMIN;

  return (
    <div className="flex h-screen bg-slate-50 overflow-hidden">
      <aside 
        className={`${
          isSidebarOpen ? 'w-64' : 'w-20'
        } bg-white transition-all duration-300 flex flex-col shadow-xl z-[1000] border-r border-slate-200`}
      >
        <div className="h-28 flex items-center justify-center border-b border-slate-100 p-2 overflow-hidden bg-slate-50/30">
          {isSidebarOpen ? (
            companyLogo ? (
              <img src={companyLogo} alt="Company Logo" className="h-20 object-contain transition-all duration-300" />
            ) : (
              <svg viewBox="0 0 280 80" className="h-16 w-auto transition-all duration-300">
                <g strokeLinecap="round" strokeLinejoin="round" fill="none">
                  <path d="M 10 60 L 30 30 L 50 60" stroke="#B91C1C" strokeWidth="8" />
                  <path d="M 30 60 L 50 30 L 70 60" stroke="#1F2937" strokeWidth="8" />
                  <path d="M 50 60 L 70 30 L 90 60" stroke="#B91C1C" strokeWidth="8" />
                  <rect x="64" y="52" width="12" height="12" transform="rotate(45 70 58)" fill="#1F2937" stroke="none" />
                </g>
                <g fontFamily="sans-serif">
                  <text x="100" y="45" fontSize="22" fontWeight="800" fill="#1F2937">Central de</text>
                  <text x="100" y="65" fontSize="22" fontWeight="800" fill="#1F2937">Maderas</text>
                </g>
              </svg>
            )
          ) : (
             companyLogo ? (
               <img src={companyLogo} alt="Logo" className="h-14 w-14 object-contain rounded transition-all" />
             ) : (
                <svg viewBox="0 0 100 80" className="h-14 w-auto transition-all">
                   <g strokeLinecap="round" strokeLinejoin="round" fill="none">
                    <path d="M 10 60 L 30 30 L 50 60" stroke="#B91C1C" strokeWidth="8" />
                    <path d="M 30 60 L 50 30 L 70 60" stroke="#1F2937" strokeWidth="8" />
                    <path d="M 50 60 L 70 30 L 90 60" stroke="#B91C1C" strokeWidth="8" />
                    <rect x="64" y="52" width="12" height="12" transform="rotate(45 70 58)" fill="#1F2937" stroke="none" />
                  </g>
                </svg>
             )
          )}
        </div>

        <div className="flex justify-end px-4 py-2 shrink-0 border-b border-slate-50">
           <button 
            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
            className="p-1.5 hover:bg-slate-100 text-slate-400 hover:text-slate-600 rounded-lg transition-colors shadow-sm"
          >
            <Menu size={20} />
          </button>
        </div>

        <nav className="flex-1 py-4 flex flex-col overflow-y-auto scrollbar-thin px-3">
          <ul className="space-y-1 mb-6">
            {mainItems.map((item) => (
              <li key={item.id}>
                <button
                  onClick={() => setActiveView(item.id)}
                  className={`w-full flex items-center px-3 py-3 rounded-xl transition-all relative group font-medium ${
                    activeView === item.id 
                      ? 'bg-red-700 text-white shadow-md shadow-red-900/10' 
                      : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                  }`}
                >
                  <item.icon 
                    size={22} 
                    className={`min-w-[22px] transition-colors ${
                      activeView === item.id ? 'text-white' : 'text-slate-400 group-hover:text-red-600'
                    }`} 
                  />
                  {isSidebarOpen && (
                    <span className="ml-3 text-sm truncate">{item.label}</span>
                  )}
                </button>
              </li>
            ))}
          </ul>

          <ul className="space-y-1 border-t border-slate-100 pt-4 mb-4">
             <li className="px-2 pb-2">
                {isSidebarOpen && <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider pl-2">Gesti贸n Operativa</span>}
              </li>
              {managementItems.map((item) => (
                <li key={item.id}>
                  <button
                    onClick={() => setActiveView(item.id)}
                    className={`w-full flex items-center px-3 py-3 rounded-xl transition-all relative group font-medium ${
                      activeView === item.id 
                        ? 'bg-amber-100 text-amber-900 shadow-sm' 
                        : 'text-slate-500 hover:bg-slate-50 hover:text-slate-900'
                    }`}
                  >
                    <item.icon 
                      size={22} 
                      className={`min-w-[22px] transition-colors ${
                        activeView === item.id ? 'text-amber-700' : 'text-slate-400 group-hover:text-amber-600'
                      }`} 
                    />
                    {isSidebarOpen && (
                      <span className="ml-3 text-sm truncate">{item.label}</span>
                    )}
                  </button>
                </li>
              ))}
          </ul>

          {isAdmin && (
            <div className="border-t border-slate-100 pt-4 mt-2">
              <button 
                onClick={() => setIsAdminExpanded(!isAdminExpanded)}
                className={`w-full flex items-center justify-between px-3 py-3 rounded-xl transition-all group font-bold text-slate-600 hover:bg-slate-50 ${isAdminExpanded ? 'text-slate-900' : ''}`}
              >
                <div className="flex items-center">
                  <Shield size={22} className={`min-w-[22px] ${isAdminExpanded ? 'text-slate-900' : 'text-slate-400 group-hover:text-slate-900'}`} />
                  {isSidebarOpen && <span className="ml-3 text-sm uppercase tracking-wider text-[11px]">Administraci贸n</span>}
                </div>
                {isSidebarOpen && (
                  isAdminExpanded ? <ChevronUp size={16} className="text-slate-400" /> : <ChevronDown size={16} className="text-slate-400" />
                )}
              </button>
              
              <div className={`mt-1 space-y-1 overflow-hidden transition-all duration-300 ${isAdminExpanded ? 'max-h-80 opacity-100' : 'max-h-0 opacity-0'}`}>
                {adminItems.map((item) => (
                  <button
                    key={item.id}
                    onClick={() => setActiveView(item.id)}
                    className={`w-full flex items-center px-3 py-2.5 rounded-xl transition-all relative group font-medium ${
                      activeView === item.id 
                        ? 'bg-slate-800 text-white shadow-md' 
                        : 'text-slate-500 hover:bg-slate-100/50 hover:text-slate-900'
                    } ${isSidebarOpen ? 'ml-4 w-[calc(100%-1rem)]' : ''}`}
                  >
                    <item.icon 
                      size={18} 
                      className={`min-w-[18px] transition-colors ${
                        activeView === item.id ? 'text-white' : 'text-slate-400 group-hover:text-slate-800'
                      }`} 
                    />
                    {isSidebarOpen && (
                      <span className="ml-3 text-xs truncate">{item.label}</span>
                    )}
                  </button>
                ))}
              </div>
            </div>
          )}
        </nav>

        <div className="p-4 border-t border-slate-100 bg-slate-50/50 shrink-0">
          <div className="flex items-center justify-between">
            <button 
              onClick={() => setActiveView('users')}
              className="flex items-center space-x-3 overflow-hidden group hover:opacity-80 transition-opacity flex-1"
            >
              <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-slate-400 border border-slate-200 shadow-sm group-hover:border-blue-400 group-hover:text-blue-500 transition-all">
                <UserCircle size={24} />
              </div>
              {isSidebarOpen && (
                <div className="flex flex-col overflow-hidden text-left">
                  <span className="text-sm font-bold truncate text-slate-700 group-hover:text-blue-600">{currentUser.name}</span>
                  <span className="text-[10px] text-slate-500 truncate uppercase tracking-wide">{currentUser.role}</span>
                </div>
              )}
            </button>
            {isSidebarOpen && (
              <button 
                onClick={onLogout}
                className="text-slate-400 hover:text-red-600 p-2 hover:bg-white rounded-lg transition-all shadow-sm ml-2" 
                title="Cerrar Sesi贸n"
              >
                <LogOut size={18} />
              </button>
            )}
          </div>
        </div>
      </aside>

      <main className="flex-1 flex flex-col overflow-hidden relative bg-slate-50">
        <header className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 z-[2000] sticky top-0 shadow-sm overflow-visible">
          <div className="flex items-center">
            <h1 className="text-xl font-bold text-slate-800 tracking-tight">
              {[...mainItems, ...managementItems, ...adminItems].find(n => n.id === activeView)?.label || 'Sistema de Gesti贸n'}
            </h1>
          </div>
          <div className="flex items-center space-x-4">
            <div className="hidden md:flex flex-col items-end mr-2">
               <span className="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-0.5">Estado de Conexi贸n</span>
               {isCloudConnected ? (
                 <span className="flex items-center text-green-600 font-bold text-sm bg-green-50 px-2 py-0.5 rounded-full border border-green-100">
                   <CloudLightning size={14} className="mr-1.5" />
                   NUBE ACTIVA
                 </span>
               ) : (
                 <span className="flex items-center text-amber-600 font-bold text-sm bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100">
                   <HardDrive size={14} className="mr-1.5" />
                   MODO LOCAL
                 </span>
               )}
            </div>
            <div className="h-8 w-px bg-slate-200 mx-2"></div>
            
            <div className="relative">
              <button 
                onClick={() => setIsNotifOpen(!isNotifOpen)}
                className={`relative p-2 rounded-full transition-all border ${isNotifOpen ? 'bg-red-50 border-red-200 text-red-600 shadow-inner' : 'text-slate-400 border-transparent hover:bg-slate-50 hover:text-slate-600 hover:border-slate-200'}`}
              >
                <Bell size={20} />
                {unreadCount > 0 && (
                  <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-600 text-white text-[9px] font-black flex items-center justify-center rounded-full border-2 border-white shadow-sm animate-bounce">
                    {unreadCount > 9 ? '+9' : unreadCount}
                  </span>
                )}
              </button>

              {isNotifOpen && (
                <>
                  <div className="fixed inset-0 z-[2500]" onClick={() => setIsNotifOpen(false)}></div>
                  <div className="absolute right-0 mt-3 w-85 bg-white rounded-3xl shadow-2xl border border-slate-200 z-[3000] overflow-hidden animate-in fade-in slide-in-from-top-4 duration-300 origin-top-right ring-1 ring-black/5">
                    <div className="p-5 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                      <h3 className="font-black text-slate-900 text-xs flex items-center uppercase tracking-widest">
                        <BellRing size={16} className="mr-2 text-red-600" />
                        Notificaciones
                      </h3>
                      <button onClick={() => setIsNotifOpen(false)} className="p-1 hover:bg-slate-200 rounded-full transition-colors text-slate-400 hover:text-slate-900">
                        <X size={18} />
                      </button>
                    </div>
                    <div className="max-h-[70vh] overflow-y-auto scrollbar-thin">
                      {notifications.length > 0 ? (
                        <div className="divide-y divide-slate-100">
                          {notifications.map(notif => (
                            <div 
                              key={notif.id} 
                              onClick={() => { handleMarkRead(notif); }}
                              className={`p-5 hover:bg-slate-50 transition-all cursor-pointer relative group ${!notif.read ? 'bg-blue-50/40' : ''}`}
                            >
                              {!notif.read && <div className="absolute left-1.5 top-5 w-1.5 h-10 bg-blue-600 rounded-full shadow-sm"></div>}
                              <div className="flex justify-between items-start mb-1.5">
                                <span className={`text-[9px] font-black uppercase tracking-widest px-2 py-0.5 rounded border ${
                                  notif.type === 'REJECTION' ? 'bg-orange-100 text-orange-800 border-orange-200' :
                                  notif.type === 'APPROVAL' ? 'bg-green-100 text-green-800 border-green-200' :
                                  notif.type === 'NEW_UPLOAD' ? 'bg-blue-100 text-blue-800 border-blue-200' : 'bg-slate-100 text-slate-700 border-slate-200'
                                }`}>
                                  {notif.type}
                                </span>
                                <span className="text-[9px] text-slate-400 flex items-center font-bold">
                                  <Clock size={10} className="mr-1" />
                                  {notif.date.split(',')[0]}
                                </span>
                              </div>
                              <h4 className={`text-xs font-black leading-tight ${!notif.read ? 'text-slate-900' : 'text-slate-600'}`}>{notif.title}</h4>
                              <p className="text-[11px] text-slate-500 mt-1.5 leading-relaxed line-clamp-2 font-medium">{notif.message}</p>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="p-14 text-center flex flex-col items-center">
                          <Check size={48} className="text-slate-100 mb-3" />
                          <p className="text-sm text-slate-400 font-bold">Bandeja de entrada vac铆a</p>
                        </div>
                      )}
                    </div>
                    <div className="p-4 bg-slate-50 border-t border-slate-200 text-center">
                       <button onClick={() => { setActiveView('users'); setIsNotifOpen(false); }} className="text-[10px] font-black text-blue-600 hover:text-blue-800 uppercase tracking-widest hover:underline decoration-2 underline-offset-4 transition-all">Configurar Preferencias</button>
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
        </header>

        <div className="flex-1 overflow-auto p-6 scrollbar-thin z-0 bg-slate-50/30">
          <div className="max-w-7xl mx-auto">
            {children}
          </div>
        </div>
      </main>
    </div>
  );
};
</file>

<file path="apphosting.yaml">
kind: AppStack
schemaVersion: v1
buildConfig:
  runtime: nodejs20
  # App Hosting buildpacks sometimes fail `npm ci` with lockfile resolution issues.
  # Use `npm install --include=dev` to reliably install build tooling (vite/typescript)
  # even when NODE_ENV is production in the builder.
  buildCommand: npm install --include=dev --no-audit --no-fund && npm run build
runConfig:
  runCommand: npm start
  cpu: 1
  memoryMiB: 1024
</file>

<file path="firebaseConfig.ts">
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth } from 'firebase/auth';
import { getStorage } from 'firebase/storage';

// --- CONFIGURACIN DE FIREBASE ---
export const firebaseConfig = {
  apiKey: "AIzaSyAW1PT30nPjdn5SqN2o2TX_O0CXkCFHxwg",
  authDomain: "sig360-35d17.firebaseapp.com",
  projectId: "sig360-35d17",
  storageBucket: "sig360-35d17.firebasestorage.app",
  messagingSenderId: "625926676036",
  appId: "1:625926676036:web:ac1cd4d96b3fe5ec85e611",
  measurementId: "G-P2QLX4QXKQ"
};

// --- ACTIVACIN DE NUBE ---
export const USE_CLOUD_DB = true; 

let app;
let db: any = null;
let auth: any = null;
let storage: any = null;

if (USE_CLOUD_DB) {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    storage = getStorage(app);
    console.log(` Firebase Conectado: ${firebaseConfig.projectId}`);
  } catch (error) {
    console.error(" Error conectando a Firebase:", error);
  }
} else {
  console.log("锔 Modo LocalStorage activo.");
}

export { db, auth, storage };
</file>

<file path="components/RequirementsManager.tsx">
import React, { useState, useEffect, useMemo, useRef } from 'react';
import { Activity, Periodicity, MonthlyExecution, StandardDefinition, Plant, User, UserRole, Area } from '../types';
import { AREAS } from '../constants';
import { dataService } from '../services/dataService';
import { 
  Plus, Edit2, Trash2, X, Search, ShieldCheck, FileText, 
  TreePine, Briefcase, Truck, Factory, CheckSquare, Square, FileUp, 
  Save, Filter, BookOpen, Layers, ClipboardCheck, AlignLeft, Target,
  ChevronDown, Loader2, Move,
  // Added AlertCircle to fix the missing import error
  AlertCircle
} from 'lucide-react';

interface RequirementsManagerProps {
  activities: Activity[];
  onAdd: (activity: Activity) => void;
  onUpdate: (activity: Activity) => void;
  onDelete: (id: string) => void;
  standardsList: StandardDefinition[];
  currentUser: User;
  areas: Area[];
}

interface PendingImport {
  rawIndex: number;
  data: Activity;
  errors: string[];
  isDuplicate: boolean;
  existingActivity?: Activity;
}

export const RequirementsManager: React.FC<RequirementsManagerProps> = ({ 
  activities, 
  onAdd, 
  onUpdate, 
  onDelete,
  standardsList,
  currentUser,
  areas
}) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedStandardFilter, setSelectedStandardFilter] = useState('ALL');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isBulkModalOpen, setIsBulkModalOpen] = useState(false);
  const [editingActivity, setEditingActivity] = useState<Activity | null>(null);
  const [selectedPeriodicity, setSelectedPeriodicity] = useState<Periodicity>(Periodicity.MONTHLY);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [plants, setPlants] = useState<Plant[]>([]);
  
  const [bulkInput, setBulkInput] = useState('');
  const [importStep, setImportStep] = useState(1); 
  const [pendingImports, setPendingImports] = useState<PendingImport[]>([]);
  const [isImporting, setIsImporting] = useState(false);

  // Estados para Draggable
  const [modalPos, setModalPos] = useState({ x: 80, y: 0 }); // Inicialmente a la derecha
  const [isDragging, setIsDragging] = useState(false);
  const dragRef = useRef<{ startX: number; startY: number }>({ startX: 0, startY: 0 });

  useEffect(() => {
    const unsub = dataService.subscribeToPlants(data => setPlants(data));
    return () => unsub();
  }, []);

  // L贸gica de arrastre
  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      if (!isDragging) return;
      setModalPos({
        x: e.clientX - dragRef.current.startX,
        y: e.clientY - dragRef.current.startY
      });
    };
    const handleMouseUp = () => setIsDragging(false);

    if (isDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
    }
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging]);

  const handleMouseDown = (e: React.MouseEvent) => {
    setIsDragging(true);
    dragRef.current.startX = e.clientX - modalPos.x;
    dragRef.current.startY = e.clientY - modalPos.y;
  };

  const filteredActivities = useMemo(() => {
    return activities.filter(activity => {
      const matchesStandard = selectedStandardFilter === 'ALL' || activity.standards.includes(selectedStandardFilter);
      const term = searchTerm.toLowerCase().trim();
      const matchesSearch = !term || 
        activity.clauseTitle.toLowerCase().includes(term) ||
        activity.subClause.toLowerCase().includes(term) ||
        activity.responsibleArea.toLowerCase().includes(term);
      return matchesStandard && matchesSearch;
    }).sort((a, b) => {
      return a.subClause.localeCompare(b.subClause, undefined, { numeric: true, sensitivity: 'base' });
    });
  }, [activities, searchTerm, selectedStandardFilter]);

  const currentAreaList = areas.length > 0 ? areas.map(a => a.name) : AREAS;

  const [formData, setFormData] = useState<Partial<Activity>>({
    clause: '', subClause: '', clauseTitle: '', description: '', contextualization: '',
    relatedQuestions: '', responsibleArea: currentAreaList[0], standards: [], plantIds: ['MOSQUERA'], 
    compliance2024: false, compliance2025: false
  });

  const handleOpenModal = (activity?: Activity) => {
    setErrorMsg(null);
    setModalPos({ x: 80, y: 0 }); // Reset pos con desplazamiento inicial a la derecha
    if (activity) {
      setEditingActivity(activity);
      setFormData({
        ...activity,
        plantIds: activity.plantIds.map(id => id.toUpperCase())
      });
      setSelectedPeriodicity(activity.periodicity || Periodicity.MONTHLY); 
    } else {
      setEditingActivity(null);
      setFormData({
        clause: '', subClause: '', clauseTitle: '', description: '', contextualization: '',
        relatedQuestions: '', responsibleArea: currentAreaList[0], standards: standardsList.length > 0 ? [standardsList[0].type] : [],
        plantIds: ['MOSQUERA'], compliance2024: false, compliance2025: false
      });
      setSelectedPeriodicity(Periodicity.MONTHLY);
    }
    setIsModalOpen(true);
  };

  const generateMonthlyPlan = (periodicity: Periodicity): MonthlyExecution[] => {
    return Array.from({ length: 12 }, (_, i) => {
      let isPlanned = false;
      switch (periodicity) {
        case Periodicity.MONTHLY: isPlanned = true; break;
        case Periodicity.BIMONTHLY: isPlanned = i % 2 === 0; break;
        case Periodicity.QUARTERLY: isPlanned = (i + 1) % 3 === 0; break;
        case Periodicity.SEMIANNUAL: isPlanned = i === 5 || i === 11; break;
        case Periodicity.ANNUAL: isPlanned = i === 11; break;
      }
      return { month: i, planned: isPlanned, executed: false, delayed: false };
    });
  };

  const handleToggleStandard = (stdType: string) => {
    const currentStds = formData.standards || [];
    setFormData({ ...formData, standards: currentStds.includes(stdType) ? currentStds.filter(s => s !== stdType) : [...currentStds, stdType] });
  };

  const handleTogglePlant = (plantId: string) => {
    const currentPlants = formData.plantIds || [];
    const targetId = plantId.toUpperCase();
    const isSelected = currentPlants.map(id => id.toUpperCase()).includes(targetId);
    if (targetId === 'MOSQUERA' && isSelected && currentPlants.length === 1) return;
    setFormData({ 
      ...formData, 
      plantIds: isSelected 
        ? currentPlants.filter(p => p.toUpperCase() !== targetId) 
        : [...currentPlants, targetId] 
    });
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.standards?.length || !formData.plantIds?.length) {
      setErrorMsg("Debe seleccionar al menos una Norma y una Planta.");
      return;
    }
    const finalPlans = editingActivity?.plans || { 2025: generateMonthlyPlan(selectedPeriodicity), 2026: generateMonthlyPlan(selectedPeriodicity) };
    const activityData: Activity = {
      id: editingActivity?.id || `ACT-${Date.now()}`,
      clause: formData.clause || '', subClause: formData.subClause || '', clauseTitle: formData.clauseTitle || '',
      description: formData.description || '', contextualization: formData.contextualization || '',
      relatedQuestions: formData.relatedQuestions || '', responsibleArea: formData.responsibleArea || currentAreaList[0],
      standards: formData.standards || [], plantIds: formData.plantIds || ['MOSQUERA'],
      periodicity: selectedPeriodicity, compliance2024: formData.compliance2024 || false,
      compliance2025: formData.compliance2025 || false, plans: finalPlans,
    };
    editingActivity ? onUpdate(activityData) : onAdd(activityData);
    setIsModalOpen(false);
  };

  const getStandardIcon = (type: string) => {
    const t = type.toLowerCase();
    if (t.includes('9001')) return FileText;
    if (t.includes('sst')) return ShieldCheck;
    if (t.includes('fsc')) return TreePine;
    if (t.includes('vial') || t.includes('pesv')) return Truck;
    return Briefcase;
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div><h2 className="text-2xl font-black text-slate-800 tracking-tight">Requisitos y Matriz</h2><p className="text-slate-500 font-medium">Configure actividades, responsables y periodicidad.</p></div>
        <div className="flex gap-3">
          {currentUser.role === UserRole.ADMIN && (
            <button onClick={() => { setIsBulkModalOpen(true); setImportStep(1); setBulkInput(''); }} className="bg-white hover:bg-slate-50 text-slate-900 border border-slate-200 px-6 py-2.5 rounded-xl flex items-center shadow-sm text-xs font-black uppercase tracking-widest"><FileUp size={18} className="mr-2 text-red-600" /> Carga Masiva</button>
          )}
          <button onClick={() => handleOpenModal()} className="bg-slate-900 hover:bg-black text-white px-6 py-2.5 rounded-xl flex items-center shadow-lg text-xs font-black uppercase tracking-widest transition-all"><Plus size={18} className="mr-2" /> Nuevo Requisito</button>
        </div>
      </div>

      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="p-5 border-b border-slate-100 bg-slate-50/50 flex flex-col md:flex-row gap-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} />
            <input 
              type="text" 
              placeholder="Buscar por numeral, t铆tulo o 谩rea..." 
              value={searchTerm} 
              onChange={(e) => setSearchTerm(e.target.value)} 
              className="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 text-sm font-medium" 
            />
          </div>
          <div className="w-full md:w-72 relative">
            <Filter className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} />
            <select value={selectedStandardFilter} onChange={(e) => setSelectedStandardFilter(e.target.value)} className="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl text-sm font-black uppercase tracking-tight bg-white">
              <option value="ALL">TODAS LAS NORMAS</option>
              {standardsList.map(s => <option key={s.id} value={s.type}>{s.type}</option>)}
            </select>
          </div>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-xs text-left border-collapse">
            <thead className="bg-slate-50 text-slate-400 font-black uppercase text-[10px] tracking-[0.2em]"><tr><th className="p-5 w-28 text-center border-r border-slate-100">Numeral</th><th className="p-5">Requisito / Norma</th><th className="p-5">Plantas</th><th className="p-5 w-40">rea</th><th className="p-5 w-32 text-center">Acciones</th></tr></thead>
            <tbody className="divide-y divide-slate-100">
              {filteredActivities.map((activity) => (
                <tr key={activity.id} className="hover:bg-slate-50/50 transition-colors group">
                  <td className="p-5 text-center font-black text-slate-700 border-r border-slate-100"><div className="bg-slate-800 text-white px-2 py-1 rounded text-[11px] font-black shadow-sm mb-1">{activity.subClause}</div></td>
                  <td className="p-5"><div className="font-black text-slate-800 mb-1">{activity.clauseTitle}</div><div className="flex flex-wrap gap-1.5 mt-1.5">{activity.standards.map((s, idx) => { const Icon = getStandardIcon(s); return <span key={idx} className="text-[8px] font-black px-2 py-0.5 bg-blue-50 text-blue-600 rounded border border-blue-100 uppercase tracking-tighter flex items-center"><Icon size={10} className="mr-1" />{s}</span>; })}</div></td>
                  <td className="p-5"><div className="flex flex-wrap gap-1">{activity.plantIds?.map(pid => { const plant = plants.find(p => p.id.toUpperCase() === pid.toUpperCase()); return <span key={pid} className={`text-[8px] font-black px-1.5 py-0.5 rounded uppercase ${plant?.isMain ? 'bg-red-50 text-red-600 border-red-100' : 'bg-slate-50 text-slate-600 border-slate-100'}`}>{plant?.name || pid}</span>; })}</div></td>
                  <td className="p-5"><span className="px-2 py-1 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-black uppercase tracking-tighter border border-slate-200">{activity.responsibleArea}</span></td>
                  <td className="p-5 text-center"><div className="flex justify-center space-x-2"><button onClick={() => handleOpenModal(activity)} className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-all"><Edit2 size={16} /></button><button onClick={() => onDelete(activity.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-all"><Trash2 size={16} /></button></div></td>
                </tr>
              ))}
              {filteredActivities.length === 0 && (
                <tr>
                  <td colSpan={5} className="p-20 text-center">
                    <div className="flex flex-col items-center">
                      <Search size={40} className="text-slate-200 mb-4" />
                      <p className="text-sm font-black text-slate-400 uppercase tracking-widest">No se encontraron requisitos con estos filtros</p>
                      <button onClick={() => {setSearchTerm(''); setSelectedStandardFilter('ALL');}} className="mt-4 text-blue-600 text-[10px] font-black uppercase tracking-widest hover:underline">Limpiar Filtros</button>
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {isModalOpen && (
        <div className="fixed inset-0 bg-slate-900/90 flex items-center justify-center z-[5000] p-4 backdrop-blur-md animate-in fade-in duration-300">
          <div 
            style={{ transform: `translate(${modalPos.x}px, ${modalPos.y}px)` }}
            className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-4xl max-h-[92vh] flex flex-col overflow-hidden border border-slate-200 relative animate-in zoom-in-95 duration-200"
          >
            <div 
              onMouseDown={handleMouseDown}
              className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0 cursor-move active:cursor-grabbing select-none"
            >
              <div className="flex items-center">
                <div className="p-3 bg-slate-900 text-white rounded-2xl mr-4 shadow-lg">
                  {editingActivity ? <Edit2 size={24} /> : <Plus size={24} />}
                </div>
                <div>
                  <h3 className="text-xl font-black text-slate-900 tracking-tight uppercase leading-none mb-1">
                    {editingActivity ? 'Editar Requisito' : 'Nuevo Requisito'}
                  </h3>
                  <p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]">Matriz de Cumplimiento Integral</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <div className="p-1.5 bg-slate-200 rounded-lg text-slate-500"><Move size={14} /></div>
                <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-900 p-2 hover:bg-slate-200 rounded-full transition-colors"><X size={24} /></button>
              </div>
            </div>

            <form onSubmit={handleSubmit} className="p-8 space-y-8 overflow-y-auto scrollbar-thin flex-1">
              {errorMsg && (
                <div className="p-4 bg-red-50 border border-red-200 text-red-600 rounded-2xl flex items-center gap-3 text-xs font-black uppercase animate-pulse">
                  <AlertCircle size={18} /> {errorMsg}
                </div>
              )}

              <div className="space-y-4">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Normas Asociadas</label>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  {standardsList.map((std) => {
                    const Icon = getStandardIcon(std.type);
                    const isS = formData.standards?.includes(std.type);
                    return (
                      <button key={std.id} type="button" onClick={() => handleToggleStandard(std.type)} 
                              className={`flex items-center p-4 rounded-2xl border-2 transition-all ${isS ? `bg-blue-50 border-blue-500 text-blue-900 shadow-sm` : 'bg-white border-slate-100 text-slate-400 hover:border-slate-200'}`}>
                        <div className={`p-2 rounded-lg mr-3 ${isS ? `bg-blue-200` : 'bg-slate-50'}`}><Icon size={18} className={isS ? `text-blue-700` : 'text-slate-300'} /></div>
                        <span className="text-[10px] font-black uppercase tracking-tight text-left">{std.type}</span>
                      </button>
                    );
                  })}
                </div>
              </div>

              <div className="space-y-4">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Sedes / Plantas</label>
                <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-3">
                  {plants.map((plt) => { 
                    const isS = formData.plantIds?.map(id => id.toUpperCase()).includes(plt.id.toUpperCase());
                    return (
                      <button key={plt.id} type="button" onClick={() => handleTogglePlant(plt.id)} 
                              className={`flex items-center p-3 rounded-xl border-2 transition-all ${isS ? `bg-red-50 border-red-500 text-red-900` : 'bg-white border-slate-100 text-slate-400 hover:border-slate-200'}`}>
                        {isS ? <CheckSquare size={16} className="mr-2 text-red-600" /> : <Square size={16} className="mr-2 text-slate-300" />}
                        <span className="text-[9px] font-black uppercase tracking-tight truncate">{plt.name}</span>
                      </button>
                    );
                  })}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="space-y-2">
                  <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Numeral (Tarea)</label>
                  <input required type="text" value={formData.subClause} 
                         onChange={e => setFormData({...formData, subClause: e.target.value, clause: e.target.value.split('.').slice(0,2).join('.')})} 
                         className="w-full px-5 py-4 border-2 border-slate-100 rounded-2xl text-sm font-black bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none" placeholder="Ej: 4.1.1" />
                </div>
                <div className="space-y-2">
                  <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest">rea Responsable</label>
                  <select value={formData.responsibleArea} onChange={e => setFormData({...formData, responsibleArea: e.target.value})} 
                          className="w-full px-5 py-4 border-2 border-slate-100 rounded-2xl text-sm font-black bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none">
                    {currentAreaList.map(area => <option key={area} value={area}>{area.toUpperCase()}</option>)}
                  </select>
                </div>
              </div>

              <div className="space-y-2">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest">T铆tulo descriptivo</label>
                <input required type="text" value={formData.clauseTitle} onChange={e => setFormData({...formData, clauseTitle: e.target.value})} 
                       className="w-full px-5 py-4 border-2 border-slate-100 rounded-2xl text-sm font-black bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none" 
                       placeholder="T铆tulo del requisito..." />
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="space-y-2">
                  <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center">
                    <AlignLeft size={14} className="mr-2" /> Descripci贸n Normativa
                  </label>
                  <textarea rows={4} value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} 
                            className="w-full border-2 border-slate-100 rounded-3xl p-5 text-sm font-medium bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none italic" 
                            placeholder="Descripci贸n textual de la norma..." />
                </div>
                <div className="space-y-2">
                  <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center">
                    <Target size={14} className="mr-2" /> Explicaci贸n Operativa
                  </label>
                  <textarea rows={4} value={formData.contextualization} onChange={e => setFormData({...formData, contextualization: e.target.value})} 
                            className="w-full border-2 border-slate-100 rounded-3xl p-5 text-sm font-bold bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none" 
                            placeholder="Interpretaci贸n interna..." />
                </div>
              </div>

              <div className="space-y-2">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center">
                  <ClipboardCheck size={14} className="mr-2" /> Criterio de Auditor铆a / Tarea
                </label>
                <textarea rows={3} value={formData.relatedQuestions} onChange={e => setFormData({...formData, relatedQuestions: e.target.value})} 
                          className="w-full border-2 border-slate-100 rounded-3xl p-5 text-sm font-black bg-slate-50 focus:bg-white focus:border-blue-500 transition-all outline-none" 
                          placeholder="Puntos a auditar..." />
              </div>

              <div className="bg-slate-900 p-8 rounded-[2.5rem] border-2 border-slate-800 shadow-xl">
                <label className="block text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">Periodicidad de Seguimiento</label>
                <div className="relative">
                  <select value={selectedPeriodicity} onChange={e => setSelectedPeriodicity(e.target.value as Periodicity)} 
                          className="w-full bg-slate-800 border-2 border-slate-700 text-white rounded-2xl p-5 text-sm font-black focus:border-blue-500 outline-none appearance-none">
                    {Object.values(Periodicity).map(p => <option key={p} value={p}>{p.toUpperCase()}</option>)}
                  </select>
                  <ChevronDown className="absolute right-5 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none" size={20} />
                </div>
              </div>

              <div className="flex gap-4 pt-6 pb-6">
                <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-5 text-slate-400 font-black text-xs uppercase tracking-widest hover:bg-slate-50 rounded-[1.5rem] transition-all">Cancelar</button>
                <button type="submit" className="flex-[2] py-5 bg-slate-900 text-white rounded-[1.5rem] font-black text-xs uppercase tracking-[0.2em] shadow-2xl hover:bg-black transition-all flex items-center justify-center active:scale-95">
                  <Save size={20} className="mr-3" /> GUARDAR REQUISITO
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="services/dataService.ts">
import { db, USE_CLOUD_DB } from '../firebaseConfig';
import { collection, onSnapshot, updateDoc, deleteDoc, doc, setDoc, query, where } from 'firebase/firestore';
import { Activity, User, StandardDefinition, AppSettings, Notification, Plant, Area } from '../types';
import { MOCK_ACTIVITIES_GERENCIA, MOCK_USERS } from '../constants';

const COLL_ACTIVITIES = 'activities';
const COLL_USERS = 'users';
const COLL_STANDARDS = 'standards';
const COLL_SETTINGS = 'settings';
const COLL_NOTIFICATIONS = 'notifications';
const COLL_PLANTS = 'plants';
const COLL_AREAS = 'areas';
const DOC_SETTINGS_GENERAL = 'general';

class DataService {
  
  private cleanPlantIds(pids: string[] | undefined): string[] {
    if (!pids || !Array.isArray(pids)) return ['MOSQUERA'];
    const cleaned = pids.map(id => String(id || '').trim().toUpperCase()).filter(id => id !== '');
    if (cleaned.length === 0) return ['MOSQUERA'];
    return Array.from(new Set(cleaned));
  }

  subscribeToActivities(onUpdate: (data: Activity[]) => void, onError?: (error: any) => void) {
    if (USE_CLOUD_DB && db) {
      try {
        return onSnapshot(collection(db, COLL_ACTIVITIES), 
          (snap) => {
            const acts = snap.docs.map(d => ({ ...d.data(), id: d.id, plantIds: this.cleanPlantIds((d.data() as any).plantIds) } as Activity));
            onUpdate(acts);
          },
          (error) => { 
            console.error("Error Actividades Firebase:", error); 
            this.loadLocalActivities(onUpdate);
            if (onError) onError(error); 
          }
        );
      } catch (e) {
        console.error("Firestore no disponible:", e);
        return this.loadLocalActivities(onUpdate);
      }
    } else {
      return this.loadLocalActivities(onUpdate);
    }
  }

  private loadLocalActivities(onUpdate: (data: Activity[]) => void) {
    const load = () => {
      const saved = localStorage.getItem('app_activities');
      onUpdate(saved ? JSON.parse(saved) : MOCK_ACTIVITIES_GERENCIA);
    };
    load();
    window.addEventListener('local-data-changed', load);
    return () => window.removeEventListener('local-data-changed', load);
  }

  subscribeToNotifications(userId: string, onUpdate: (data: Notification[]) => void) {
    if (USE_CLOUD_DB && db) {
      try {
        const q = query(collection(db, COLL_NOTIFICATIONS), where('userId', '==', userId));
        return onSnapshot(q, (snap) => {
          const notifs = snap.docs.map(d => ({ ...d.data(), id: d.id } as Notification));
          notifs.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
          onUpdate(notifs.slice(0, 50));
        }, (err) => {
          console.error("Error Notificaciones Firebase:", err);
          onUpdate([]);
        });
      } catch (e) { return () => {}; }
    } else {
      const load = () => {
        const saved = localStorage.getItem(`notifs_${userId}`);
        onUpdate(saved ? JSON.parse(saved) : []);
      };
      load();
      window.addEventListener('local-data-changed', load);
      return () => window.removeEventListener('local-data-changed', load);
    }
  }

  subscribeToUsers(onUpdate: (data: User[]) => void) {
    if (USE_CLOUD_DB && db) {
      try {
        return onSnapshot(collection(db, COLL_USERS), (snap) => {
          onUpdate(snap.docs.map(d => ({ ...d.data(), id: d.id } as User)));
        }, () => this.loadLocalUsers(onUpdate));
      } catch (e) { return this.loadLocalUsers(onUpdate); }
    } else {
      return this.loadLocalUsers(onUpdate);
    }
  }

  private loadLocalUsers(onUpdate: (data: User[]) => void) {
    const load = () => {
      const saved = localStorage.getItem('app_users');
      onUpdate(saved ? JSON.parse(saved) : MOCK_USERS);
    };
    load();
    window.addEventListener('local-data-changed', load);
    return () => window.removeEventListener('local-data-changed', load);
  }

  subscribeToPlants(onUpdate: (data: Plant[]) => void) {
    if (USE_CLOUD_DB && db) {
      try {
        return onSnapshot(collection(db, COLL_PLANTS), (snap) => {
          onUpdate(snap.docs.map(d => ({ ...d.data(), id: d.id } as Plant)));
        }, () => onUpdate([]));
      } catch (e) { onUpdate([]); return () => {}; }
    } else {
      const load = () => {
        const saved = localStorage.getItem('app_plants');
        onUpdate(saved ? JSON.parse(saved) : []);
      };
      load();
      window.addEventListener('local-data-changed', load);
      return () => window.removeEventListener('local-data-changed', load);
    }
  }

  subscribeToAreas(onUpdate: (data: Area[]) => void) {
    if (USE_CLOUD_DB && db) {
      try {
        return onSnapshot(collection(db, COLL_AREAS), (snap) => {
          onUpdate(snap.docs.map(d => ({ ...d.data(), id: d.id } as Area)));
        }, () => onUpdate([]));
      } catch (e) { onUpdate([]); return () => {}; }
    } else {
      const load = () => {
        const saved = localStorage.getItem('app_areas');
        onUpdate(saved ? JSON.parse(saved) : []);
      };
      load();
      window.addEventListener('local-data-changed', load);
      return () => window.removeEventListener('local-data-changed', load);
    }
  }

  subscribeToStandards(onUpdate: (data: StandardDefinition[]) => void) {
    if (USE_CLOUD_DB && db) {
      try {
        return onSnapshot(collection(db, COLL_STANDARDS), (snap) => {
          onUpdate(snap.docs.map(d => ({ ...d.data(), id: d.id } as StandardDefinition)));
        }, () => onUpdate([]));
      } catch (e) { onUpdate([]); return () => {}; }
    } else {
      const load = () => {
        const saved = localStorage.getItem('app_standards');
        onUpdate(saved ? JSON.parse(saved) : []);
      };
      load();
      window.addEventListener('local-data-changed', load);
      return () => window.removeEventListener('local-data-changed', load);
    }
  }

  subscribeToSettings(onUpdate: (data: AppSettings) => void) {
    if (USE_CLOUD_DB && db) {
      try {
        return onSnapshot(doc(db, COLL_SETTINGS, DOC_SETTINGS_GENERAL), (d) => {
          onUpdate(d.exists() ? (d.data() as AppSettings) : { companyLogo: null });
        }, () => onUpdate({ companyLogo: null }));
      } catch (e) { onUpdate({ companyLogo: null }); return () => {}; }
    } else {
      const load = () => onUpdate({ companyLogo: localStorage.getItem('company_logo') });
      load();
      window.addEventListener('local-data-changed', load);
      return () => window.removeEventListener('local-data-changed', load);
    }
  }

  async updateSettings(settings: AppSettings) {
    const data = this.cleanData(settings);
    if (USE_CLOUD_DB && db) {
      await setDoc(doc(db, COLL_SETTINGS, DOC_SETTINGS_GENERAL), data, { merge: true });
    } else {
      if (data.companyLogo !== undefined) {
        if (data.companyLogo === null) localStorage.removeItem('company_logo');
        else localStorage.setItem('company_logo', data.companyLogo);
      }
      window.dispatchEvent(new Event('local-data-changed'));
    }
  }

  async markNotificationAsRead(id: string, userId: string) {
    if (USE_CLOUD_DB && db) {
      await updateDoc(doc(db, COLL_NOTIFICATIONS, id), { read: true });
    } else {
      const saved = localStorage.getItem(`notifs_${userId}`);
      if (saved) {
        const notifs = JSON.parse(saved).map((n: any) => n.id === id ? { ...n, read: true } : n);
        localStorage.setItem(`notifs_${userId}`, JSON.stringify(notifs));
        window.dispatchEvent(new Event('local-data-changed'));
      }
    }
  }

  async addActivity(activity: Activity) {
    const data = this.cleanData({ ...activity, plantIds: this.cleanPlantIds(activity.plantIds) });
    if (USE_CLOUD_DB && db) {
      await setDoc(doc(db, COLL_ACTIVITIES, activity.id), data);
    } else {
      const current = JSON.parse(localStorage.getItem('app_activities') || '[]');
      localStorage.setItem('app_activities', JSON.stringify([...current, data]));
      window.dispatchEvent(new Event('local-data-changed'));
    }
  }

  async updateActivity(activity: Activity) {
    const data = this.cleanData(activity);
    if (USE_CLOUD_DB && db) {
      await updateDoc(doc(db, COLL_ACTIVITIES, activity.id), data);
    } else {
      const current = JSON.parse(localStorage.getItem('app_activities') || '[]');
      localStorage.setItem('app_activities', JSON.stringify(current.map((a: any) => a.id === activity.id ? data : a)));
      window.dispatchEvent(new Event('local-data-changed'));
    }
  }

  async deleteActivity(id: string) {
    if (USE_CLOUD_DB && db) {
      await deleteDoc(doc(db, COLL_ACTIVITIES, id));
    } else {
      const current = JSON.parse(localStorage.getItem('app_activities') || '[]');
      localStorage.setItem('app_activities', JSON.stringify(current.filter((a: any) => a.id !== id)));
      window.dispatchEvent(new Event('local-data-changed'));
    }
  }

  async addPlant(p: Plant) {
    if (USE_CLOUD_DB && db) await setDoc(doc(db, COLL_PLANTS, p.id), this.cleanData(p));
  }
  async updatePlant(p: Plant) {
    if (USE_CLOUD_DB && db) await updateDoc(doc(db, COLL_PLANTS, p.id), this.cleanData(p));
  }
  async deletePlant(id: string) {
    if (USE_CLOUD_DB && db) await deleteDoc(doc(db, COLL_PLANTS, id));
  }

  async addArea(a: Area) {
    if (USE_CLOUD_DB && db) await setDoc(doc(db, COLL_AREAS, a.id), this.cleanData(a));
  }
  async updateArea(a: Area) {
    if (USE_CLOUD_DB && db) await updateDoc(doc(db, COLL_AREAS, a.id), this.cleanData(a));
  }
  async deleteArea(id: string) {
    if (USE_CLOUD_DB && db) await deleteDoc(doc(db, COLL_AREAS, id));
  }

  async addStandard(s: StandardDefinition) {
    if (USE_CLOUD_DB && db) await setDoc(doc(db, COLL_STANDARDS, s.id), this.cleanData(s));
  }
  async updateStandard(s: StandardDefinition) {
    if (USE_CLOUD_DB && db) await updateDoc(doc(db, COLL_STANDARDS, s.id), this.cleanData(s));
  }

  async addUser(u: User) {
    if (USE_CLOUD_DB && db) await setDoc(doc(db, COLL_USERS, u.id), this.cleanData(u));
  }
  async updateUser(u: User) {
    if (USE_CLOUD_DB && db) await updateDoc(doc(db, COLL_USERS, u.id), this.cleanData(u));
  }
  async deleteUser(id: string) {
    if (USE_CLOUD_DB && db) await deleteDoc(doc(db, COLL_USERS, id));
  }

  private cleanData(obj: any): any {
    if (obj === null || obj === undefined) return null;
    if (Array.isArray(obj)) return obj.map(v => this.cleanData(v));
    if (typeof obj === 'object') {
      const n: any = {};
      Object.keys(obj).forEach(k => {
        if (k !== 'id') n[k] = this.cleanData(obj[k]);
      });
      return n;
    }
    return obj;
  }
}

export const dataService = new DataService();
</file>

<file path="App.tsx">
import React, { useState, useEffect, useMemo } from 'react';
import { Layout } from './components/Layout';
import { Dashboard } from './components/Dashboard';
import { StandardView } from './components/StandardView';
import { RequirementsManager } from './components/RequirementsManager';
import { Login } from './components/Login';
import { UserManagement } from './components/UserManagement';
import { SystemSettings } from './components/SystemSettings';
import { StandardManager } from './components/StandardManager';
import { EvidenceDashboard } from './components/EvidenceDashboard';
import { PlantManager } from './components/PlantManager';
import { AreaManager } from './components/AreaManager';
import { Activity, User, StandardDefinition, Plant, Area } from './types';
import { dataService } from './services/dataService';
import { USE_CLOUD_DB } from './firebaseConfig';
import { Database, Loader2 } from 'lucide-react';

/**
 * SIG-Manager Pro - Arquitectura Modularizada
 * M贸dulos: 
 * - Dashboard (Control de Mando)
 * - Operaci贸n (Gesti贸n de Normas por grilla)
 * - Hallazgos (Control de Evidencias)
 * - Administraci贸n (Configuraci贸n de Base)
 */
function App() {
  const [currentUser, setCurrentUser] = useState<User | null>(null);
  const [companyLogo, setCompanyLogo] = useState<string | null>(null);
  const [activities, setActivities] = useState<Activity[]>([]);
  const [users, setUsers] = useState<User[]>([]);
  const [standards, setStandards] = useState<StandardDefinition[]>([]);
  const [plants, setPlants] = useState<Plant[]>([]);
  const [areas, setAreas] = useState<Area[]>([]);
  
  const [loadingStates, setLoadingStates] = useState({
    activities: true,
    users: true,
    standards: true,
    plants: true,
    areas: true,
    settings: true
  });

  const [dbError, setDbError] = useState<string | null>(null);
  const [isCloudConnected, setIsCloudConnected] = useState(false);
  const [currentYear, setCurrentYear] = useState<number>(new Date().getFullYear());
  const [activeView, setActiveView] = useState('dashboard');

  const isLoading = useMemo(() => Object.values(loadingStates).some(s => s), [loadingStates]);

  useEffect(() => {
    // Timer de seguridad para evitar loops infinitos de carga
    const safetyTimer = setTimeout(() => {
      setLoadingStates(prev => Object.keys(prev).reduce((acc, k) => ({...acc, [k]: false}), {} as any));
    }, 10000);

    const unsubscribes = [
      dataService.subscribeToActivities(
        (data) => { 
          setActivities(data); 
          setLoadingStates(s => ({...s, activities: false})); 
          if (USE_CLOUD_DB) setIsCloudConnected(true); 
        },
        (error) => { 
          setLoadingStates(s => ({...s, activities: false})); 
          if (error?.code === 'failed-precondition') setDbError("Faltan 铆ndices en la base de datos."); 
        }
      ),
      dataService.subscribeToUsers(data => { setUsers(data); setLoadingStates(s => ({...s, users: false})); }),
      dataService.subscribeToStandards(data => { setStandards(data); setLoadingStates(s => ({...s, standards: false})); }),
      dataService.subscribeToPlants(data => { setPlants(data); setLoadingStates(s => ({...s, plants: false})); }),
      dataService.subscribeToAreas(data => { setAreas(data); setLoadingStates(s => ({...s, areas: false})); }),
      dataService.subscribeToSettings(data => { setCompanyLogo(data?.companyLogo || null); setLoadingStates(s => ({...s, settings: false})); })
    ];

    return () => {
      clearTimeout(safetyTimer);
      unsubscribes.forEach(unsub => unsub());
    };
  }, []);

  const handlers = {
    standard: {
      update: async (std: StandardDefinition) => await dataService.updateStandard(std),
    },
    activity: {
      add: async (act: Activity) => await dataService.addActivity(act),
      update: async (act: Activity) => await dataService.updateActivity(act),
      delete: async (id: string) => { if (window.confirm("驴Confirmar eliminaci贸n?")) await dataService.deleteActivity(id); }
    },
    user: {
      add: async (u: User) => await dataService.addUser(u),
      update: async (u: User) => await dataService.updateUser(u),
      delete: async (id: string) => { if (window.confirm("驴Eliminar usuario?")) await dataService.deleteUser(id); }
    },
    plant: {
      add: async (p: Plant) => await dataService.addPlant(p),
      update: async (p: Plant) => await dataService.updatePlant(p),
      delete: async (id: string) => { await dataService.deletePlant(id); }
    },
    area: {
      add: async (a: Area) => await dataService.addArea(a),
      update: async (a: Area) => await dataService.updateArea(a),
      delete: async (id: string) => { await dataService.deleteArea(id); }
    }
  };

  const handleLogin = (user: User) => { setCurrentUser(user); setActiveView('dashboard'); };
  const handleLogout = () => { setCurrentUser(null); setActiveView('dashboard'); };

  if (isLoading) {
    return (
      <div className="flex h-screen items-center justify-center space-y-4 flex-col bg-slate-50">
        <Loader2 className="animate-spin h-12 w-12 text-red-700" />
        <div className="text-center">
          <p className="font-black text-slate-800 uppercase tracking-widest text-sm">Sincronizando Sistema</p>
          <p className="text-[10px] text-slate-400 font-bold uppercase mt-1 italic">Cargando M贸dulos Independientes...</p>
        </div>
      </div>
    );
  }

  if (dbError && USE_CLOUD_DB) {
    return (
      <div className="flex h-screen items-center justify-center p-8 text-center flex-col bg-white">
        <Database size={64} className="mb-6 text-red-600 animate-pulse" />
        <h2 className="text-2xl font-black text-slate-900 uppercase tracking-tight">Error de Conexi贸n</h2>
        <p className="text-slate-500 mt-2 max-w-md font-medium">{dbError}</p>
        <button onClick={() => window.location.reload()} className="mt-8 bg-slate-900 text-white px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl">Reintentar</button>
      </div>
    );
  }

  if (!currentUser) return <Login onLogin={handleLogin} companyLogo={companyLogo} users={users} />;

  const renderModule = () => {
    // Inyecci贸n de M贸dulos Din谩micos (Normas)
    if (activeView.startsWith('std-')) {
      const stdType = activeView.replace('std-', '');
      return (
        <StandardView 
          standard={stdType} 
          activities={activities} 
          areas={areas} 
          onUpdateActivity={handlers.activity.update} 
          currentYear={currentYear} 
          setCurrentYear={setCurrentYear} 
          currentUser={currentUser} 
        />
      );
    }

    // M贸dulos Independientes
    switch (activeView) {
      case 'dashboard': 
        return <Dashboard activities={activities} areas={areas} plants={plants} currentYear={currentYear} />;
      
      case 'evidence-dashboard': 
        return <EvidenceDashboard activities={activities} currentUser={currentUser} onUpdateActivity={handlers.activity.update} />;
      
      case 'norms': 
        return <StandardManager standards={standards} onUpdateStandard={handlers.standard.update} currentUser={currentUser} />;
      
      case 'requirements': 
        return <RequirementsManager activities={activities} onAdd={handlers.activity.add} onUpdate={handlers.activity.update} onDelete={handlers.activity.delete} standardsList={standards} currentUser={currentUser} areas={areas} />;
      
      case 'plants': 
        return <PlantManager plants={plants} onAdd={handlers.plant.add} onUpdate={handlers.plant.update} onDelete={handlers.plant.delete} />;
      
      case 'areas': 
        return <AreaManager areas={areas} users={users} onAdd={handlers.area.add} onUpdate={handlers.area.update} onDelete={handlers.area.delete} />;
      
      case 'users': 
        return <UserManagement users={users} onAddUser={handlers.user.add} onUpdateUser={handlers.user.update} onDeleteUser={handlers.user.delete} areas={areas} />;
      
      case 'settings': 
        return <SystemSettings currentLogo={companyLogo} onLogoChange={(logo) => setCompanyLogo(logo)} />;
      
      default: 
        return <Dashboard activities={activities} areas={areas} plants={plants} currentYear={currentYear} />;
    }
  };

  return (
    <Layout 
      activeView={activeView} 
      setActiveView={setActiveView} 
      currentUser={currentUser} 
      onLogout={handleLogout} 
      companyLogo={companyLogo} 
      isCloudConnected={isCloudConnected} 
      standards={standards}
    >
      {renderModule()}
    </Layout>
  );
}

export default App;
</file>

<file path="components/StandardView.tsx">
import React, { useState, useEffect, useMemo, useRef } from 'react';
import { MONTHS } from '../constants';
import { Activity, Area, Periodicity, User, Evidence, CommentLog, MonthlyExecution, Plant } from '../types';
import { 
  Check, X, Cloud, FileText, AlertCircle, Filter, Eye, Clock, History, 
  ShieldCheck, CheckCircle, Info, BookOpen, Target, Factory, Shield, 
  FileUp, ExternalLink, ListChecks, ArrowRight, Layers, MapPin, BadgeCheck,
  TreePine, Upload, Move, Link, Globe, ShieldAlert, Folder, Search,
  UserCircle, ChevronLeft, Library, Download, Briefcase, Tags, FileSearch, Monitor,
  Loader2, TableProperties, FileType, Layout
} from 'lucide-react';
import { dataService } from '../services/dataService';
import * as XLSX from 'xlsx';
import mammoth from 'mammoth';

interface StandardViewProps {
  standard: string;
  activities: Activity[];
  areas: Area[];
  onUpdateActivity: (activity: Activity) => void;
  currentYear: number;
  setCurrentYear: (year: number) => void;
  currentUser: User;
}

const SIG_LIBRARY_FS: Record<string, any[]> = {
  'root': [
    { id: 'f1', name: 'Repositorio Auditor铆a 2025', type: 'folder', items: 'auditoria' },
    { id: 'f2', name: 'Documentaci贸n Legal Central', type: 'folder', items: 'legal' },
    { id: '1', name: 'Manual_Gestion_Calidad_V5.pdf', size: '2.4 MB', type: 'pdf' },
  ],
  'auditoria': [
    { id: '2', name: 'Acta_Revision_Gerencia_Q1.pdf', size: '1.2 MB', type: 'pdf' },
    { id: '3', name: 'Matriz_Riesgos_Consolidada.xlsx', size: '450 KB', type: 'excel' },
    { id: '4', name: 'Certificado_ISO_9001_2025.jpg', size: '2.8 MB', type: 'image' },
    { id: '5', name: 'Evidencia_Capacitacion_HSEQ.pdf', size: '5.1 MB', type: 'pdf' },
  ],
  'legal': [
    { id: '7', name: 'Camara_Comercio_Actualizada.pdf', size: '1.1 MB', type: 'pdf' },
    { id: '8', name: 'RUT_Central_Maderas.pdf', size: '300 KB', type: 'pdf' },
  ]
};

export const StandardView: React.FC<StandardViewProps> = ({ 
  standard: initialStandard, 
  activities, 
  areas,
  onUpdateActivity,
  currentYear,
  setCurrentYear,
  currentUser
}) => {
  const [selectedArea, setSelectedArea] = useState('ALL');
  const [selectedPlant, setSelectedPlant] = useState('ALL'); 
  const [selectedStandard, setSelectedStandard] = useState(initialStandard);
  const [plants, setPlants] = useState<Plant[]>([]);
  const [modalOpen, setModalOpen] = useState(false);
  const [infoModalOpen, setInfoModalOpen] = useState(false);
  const [previewModalOpen, setPreviewModalOpen] = useState(false);
  const [activeActivityId, setActiveActivityId] = useState<string | null>(null);
  const [activeMonthIndex, setActiveMonthIndex] = useState<number | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [adminComment, setAdminComment] = useState('');
  const [uploadTab, setUploadTab] = useState<'FILE' | 'LINK'>('FILE');
  const [externalUrl, setExternalUrl] = useState('');
  const [previewFile, setPreviewFile] = useState<{url: string, name: string, blobUrl?: string} | null>(null);
  const [excelPreview, setExcelPreview] = useState<string | null>(null);
  const [wordPreview, setWordPreview] = useState<string | null>(null);
  const [isPreviewLoading, setIsPreviewLoading] = useState(false);

  useEffect(() => {
    setSelectedStandard(initialStandard);
  }, [initialStandard]);

  const [showLibraryPicker, setShowLibraryPicker] = useState(false);
  const [currentFolderPath, setCurrentFolderPath] = useState<string[]>(['root']);

  const [modalPos, setModalPos] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const dragRef = useRef<{ startX: number; startY: number }>({ startX: 0, startY: 0 });

  const [previewModalPos, setPreviewModalPos] = useState({ x: 0, y: 0 });
  const [isPreviewDragging, setIsPreviewDragging] = useState(false);
  const previewDragRef = useRef<{ startX: number; startY: number }>({ startX: 0, startY: 0 });

  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    const unsub = dataService.subscribeToPlants(data => setPlants(data));
    return () => unsub();
  }, []);

  const createBlobUrl = (dataUri: string) => {
    try {
      if (!dataUri || !dataUri.startsWith('data:')) return dataUri;
      const parts = dataUri.split(';base64,');
      if (parts.length < 2) return dataUri;
      
      const contentType = parts[0].split(':')[1];
      const raw = window.atob(parts[1]);
      const rawLength = raw.length;
      const uInt8Array = new Uint8Array(rawLength);
      for (let i = 0; i < rawLength; ++i) {
        uInt8Array[i] = raw.charCodeAt(i);
      }
      const blob = new Blob([uInt8Array], { type: contentType });
      return URL.createObjectURL(blob);
    } catch (e) {
      console.error("Error creando Blob URL:", e);
      return dataUri;
    }
  };

  const handleMouseDown = (e: React.MouseEvent) => {
    setIsDragging(true);
    dragRef.current.startX = e.clientX - modalPos.x;
    dragRef.current.startY = e.clientY - modalPos.y;
  };

  const handlePreviewMouseDown = (e: React.MouseEvent) => {
    setIsPreviewDragging(true);
    previewDragRef.current.startX = e.clientX - previewModalPos.x;
    previewDragRef.current.startY = e.clientY - previewModalPos.y;
  };

  useEffect(() => {
    const handleMouseMove = (e: MouseEvent) => {
      if (isDragging) {
        setModalPos({
          x: e.clientX - dragRef.current.startX,
          y: e.clientY - dragRef.current.startY
        });
      }
      if (isPreviewDragging) {
        setPreviewModalPos({
          x: e.clientX - previewDragRef.current.startX,
          y: e.clientY - previewDragRef.current.startY
        });
      }
    };
    const handleMouseUp = () => {
      setIsDragging(false);
      setIsPreviewDragging(false);
    };
    if (isDragging || isPreviewDragging) {
      window.addEventListener('mousemove', handleMouseMove);
      window.addEventListener('mouseup', handleMouseUp);
    }
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleMouseUp);
    };
  }, [isDragging, isPreviewDragging]);

  const filteredActivities = useMemo(() => {
    return activities
      .filter(a => {
        const matchesStandard = selectedStandard === 'ALL' || a.standards.includes(selectedStandard);
        const matchesArea = selectedArea === 'ALL' || a.responsibleArea === selectedArea;
        const matchesPlant = selectedPlant === 'ALL' || 
          (a.plantIds && a.plantIds.map(id => id.toUpperCase()).includes(selectedPlant.toUpperCase()));
        return matchesStandard && matchesArea && matchesPlant;
      })
      .sort((a, b) => {
        const pA = a.subClause.split('.').map(n => parseInt(n) || 0);
        const pB = b.subClause.split('.').map(n => parseInt(n) || 0);
        for (let i = 0; i < Math.max(pA.length, pB.length); i++) {
          const valA = pA[i] || 0;
          const valB = pB[i] || 0;
          if (valA !== valB) return valA - valB;
        }
        return 0;
      });
  }, [activities, selectedStandard, selectedArea, selectedPlant]);

  const stats = useMemo(() => {
    let approved = 0, pending = 0, rejected = 0, overdue = 0;
    const currentRealMonth = new Date().getMonth(), currentRealYear = new Date().getFullYear();
    filteredActivities.forEach(activity => {
      const plan = activity.plans?.[currentYear] || [];
      plan.forEach((m, idx) => {
        if (m.planned) {
          if (m.evidence) {
            if (m.evidence.status === 'APPROVED') approved++;
            else if (m.evidence.status === 'REJECTED') rejected++;
            else pending++;
          } else {
            if (currentYear < currentRealYear || (currentYear === currentRealYear && idx <= currentRealMonth)) overdue++;
          }
        }
      });
    });
    return { approved, pending, rejected, overdue, totalActive: filteredActivities.length };
  }, [filteredActivities, currentYear]);

  const openModal = (activityId: string, monthIndex: number) => {
    setActiveActivityId(activityId);
    setActiveMonthIndex(monthIndex);
    setModalOpen(true);
    setAdminComment('');
    setIsSaving(false);
    setUploadTab('FILE');
    setExternalUrl('');
    setModalPos({ x: 0, y: 0 }); 
    setShowLibraryPicker(false);
    setCurrentFolderPath(['root']);
  };

  const openInfoModal = (activityId: string) => {
    setActiveActivityId(activityId);
    setInfoModalOpen(true);
  };

  const openPreview = async (url: string, name: string) => {
    setIsPreviewLoading(true);
    setExcelPreview(null);
    setWordPreview(null);
    setPreviewModalPos({ x: 0, y: 0 });
    
    try {
      const bUrl = createBlobUrl(url);
      setPreviewFile({ url, name, blobUrl: bUrl });
      setPreviewModalOpen(true);

      const lowerName = name.toLowerCase();

      // Motor Excel
      if (lowerName.endsWith('.xlsx') || lowerName.endsWith('.xls')) {
        try {
          const response = await fetch(bUrl);
          const arrayBuffer = await response.arrayBuffer();
          const data = new Uint8Array(arrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const html = XLSX.utils.sheet_to_html(worksheet);
          const styledHtml = `<style>table { width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif; font-size: 11px; color: #1e293b; background: white; } th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; min-width: 100px; } th { background-color: #f8fafc; font-weight: 800; text-transform: uppercase; color: #64748b; letter-spacing: 0.05em; } tr:nth-child(even) { background-color: #f1f5f9; } tr:hover { background-color: #e2e8f0; }</style>${html}`;
          setExcelPreview(styledHtml);
        } catch (e) {
          console.error("Error renderizando Excel:", e);
        }
      } 
      // Motor Word (Mammoth.js)
      else if (lowerName.endsWith('.docx')) {
        try {
          const response = await fetch(bUrl);
          const arrayBuffer = await response.arrayBuffer();
          const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
          const styledHtml = `
            <style>
              .word-container { 
                padding: 50px 70px; 
                background: white; 
                font-family: 'Times New Roman', Times, serif; 
                line-height: 1.6; 
                color: #333; 
                box-shadow: 0 0 40px rgba(0,0,0,0.1); 
                max-width: 850px; 
                margin: 0 auto; 
                min-height: 1000px;
              }
              .word-container h1 { font-size: 24pt; font-weight: bold; border-bottom: 2px solid #333; margin-bottom: 20px; }
              .word-container h2 { font-size: 18pt; font-weight: bold; color: #b91c1c; margin-top: 25px; }
              .word-container p { margin-bottom: 15px; font-size: 12pt; text-align: justify; }
              .word-container table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              .word-container td, .word-container th { border: 1px solid #999; padding: 8px; }
              .word-container ul, .word-container ol { margin-left: 30px; margin-bottom: 15px; }
            </style>
            <div class="word-container">${result.value}</div>
          `;
          setWordPreview(styledHtml);
        } catch (e) {
          console.error("Error renderizando Word:", e);
        }
      }
    } catch (globalError) {
      console.error("Error cr铆tico al preparar previsualizaci贸n:", globalError);
    } finally {
      setIsPreviewLoading(false);
    }
  };

  useEffect(() => {
    return () => {
      if (previewFile?.blobUrl && previewFile.blobUrl.startsWith('blob:')) {
        URL.revokeObjectURL(previewFile.blobUrl);
      }
    };
  }, [previewFile]);

  const handleDownload = (url: string, name: string) => {
    if (!url) return;
    const link = document.createElement('a');
    link.href = url;
    link.download = name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleEvidenceSubmit = async (type: 'FILE' | 'LINK', data: string, name?: string) => {
    if (!activeActivityId || activeMonthIndex === null) return;
    setIsSaving(true);
    const activityToUpdate = activities.find(a => a.id === activeActivityId);
    if (!activityToUpdate) return;
    const currentPlans = activityToUpdate.plans || {};
    let currentYearPlan = [...(currentPlans[currentYear] || [])];
    if (currentYearPlan.length === 0) {
      currentYearPlan = Array.from({ length: 12 }, (_, i) => ({ month: i, planned: false, executed: false, delayed: false }));
    }
    const previousEvidence = currentYearPlan[activeMonthIndex].evidence;
    const historyEntry: CommentLog = {
      id: 'h-' + Date.now(),
      text: previousEvidence?.status === 'REJECTED' ? `Re-carga tras rechazo: ${name || data}` : `Carga inicial: ${name || data}`,
      author: currentUser.name,
      date: new Date().toLocaleString(),
      status: 'PENDING',
      fileUrl: previousEvidence?.url,
      fileName: previousEvidence?.fileName
    };
    const newEvidence: Evidence = {
      url: data,
      type: type,
      fileName: name || (type === 'LINK' ? 'Enlace Biblioteca' : 'Documento'),
      uploadedBy: currentUser.name,
      uploadedAt: new Date().toLocaleString(),
      status: 'PENDING',
      history: [historyEntry, ...(previousEvidence?.history || [])]
    };
    currentYearPlan[activeMonthIndex] = { ...currentYearPlan[activeMonthIndex], planned: true, evidence: newEvidence };
    const updatedActivity: Activity = { ...activityToUpdate, plans: { ...currentPlans, [currentYear]: currentYearPlan } };
    await onUpdateActivity(updatedActivity);
    setIsSaving(false);
  };

  const handleAdminVerification = async (status: 'APPROVED' | 'REJECTED') => {
    if (!activeActivityId || activeMonthIndex === null) return;
    setIsSaving(true);
    const activityToUpdate = activities.find(a => a.id === activeActivityId);
    if (!activityToUpdate) return;
    const currentYearPlan = [...(activityToUpdate.plans?.[currentYear] || [])];
    const targetPlan = currentYearPlan[activeMonthIndex];
    if (!targetPlan?.evidence) return;
    const newCommentEntry: CommentLog = {
      id: `log-adm-${Date.now()}`,
      text: adminComment || (status === 'APPROVED' ? 'Aprobado.' : 'Rechazado.'),
      author: currentUser.name,
      date: new Date().toLocaleString(),
      status: status
    };
    const updatedEvidence: Evidence = { ...targetPlan.evidence, status: status, adminComment: newCommentEntry.text, approvedBy: status === 'APPROVED' ? currentUser.name : null as any, rejectionDate: status === 'REJECTED' ? new Date().toISOString() : null as any, history: [newCommentEntry, ...targetPlan.evidence.history] };
    currentYearPlan[activeMonthIndex] = { ...targetPlan, evidence: updatedEvidence };
    const updatedActivity: Activity = { ...activityToUpdate, plans: { ...(activityToUpdate.plans || {}), [currentYear]: currentYearPlan } };
    await onUpdateActivity(updatedActivity);
    setIsSaving(false);
    setModalOpen(false);
  };

  const selectLibraryFile = (file: any) => {
    if (file.type === 'folder') {
      setCurrentFolderPath([...currentFolderPath, file.items]);
      return;
    }
    const url = `sig-internal-lib://view?id=${file.id}`;
    handleEvidenceSubmit('LINK', url, file.name);
    setShowLibraryPicker(false);
  };

  const goBackLibrary = () => {
    if (currentFolderPath.length > 1) setCurrentFolderPath(currentFolderPath.slice(0, -1));
  };

  const getCurrentLibraryFiles = () => {
    const last = currentFolderPath[currentFolderPath.length - 1];
    return SIG_LIBRARY_FS[last] || [];
  };

  const renderPeriodicityCells = (activity: Activity) => {
    const plan = activity.plans?.[currentYear] || [];
    const cells = [];
    const currentRealMonth = new Date().getMonth();
    const currentRealYear = new Date().getFullYear();
    let i = 0;
    while (i < 12) {
      let colSpan = 1;
      switch (activity.periodicity) {
        case Periodicity.ANNUAL: colSpan = 12; break;
        case Periodicity.SEMIANNUAL: colSpan = 6; break;
        case Periodicity.QUARTERLY: colSpan = 3; break;
        case Periodicity.BIMONTHLY: colSpan = 2; break;
        case Periodicity.MONTHLY: default: colSpan = 1; break;
      }
      if (i + colSpan > 12) colSpan = 12 - i;
      let evidenceFound = null; let evidenceIndex = -1; let hasAnyPlannedInSpan = false; let plannedIndex = -1; let isOverdue = false;
      for (let k = i; k < i + colSpan; k++) {
        let isMonthPlanned = false;
        if (plan.length > 0) { if (plan[k]?.planned) isMonthPlanned = true; } 
        else {
          switch (activity.periodicity) {
            case Periodicity.MONTHLY: isMonthPlanned = true; break;
            case Periodicity.ANNUAL: isMonthPlanned = k === 11; break;
            case Periodicity.SEMIANNUAL: isMonthPlanned = k === 5 || k === 11; break;
            case Periodicity.QUARTERLY: isMonthPlanned = (k + 1) % 3 === 0; break;
            case Periodicity.BIMONTHLY: isMonthPlanned = k % 2 === 0; break;
          }
        }
        if (isMonthPlanned) {
          hasAnyPlannedInSpan = true;
          if (plannedIndex === -1) plannedIndex = k; 
          if (plan[k]?.evidence) { evidenceFound = plan[k].evidence; evidenceIndex = k; } 
          else { if (currentYear < currentRealYear || (currentYear === currentRealYear && k <= currentRealMonth)) isOverdue = true; }
        }
      }
      let cellBg = "bg-white"; let cellContent = null; let interactionIndex = evidenceIndex !== -1 ? evidenceIndex : (plannedIndex !== -1 ? plannedIndex : i);
      if (evidenceFound) {
        if (evidenceFound.status === 'APPROVED') { cellBg = "bg-green-50/50"; cellContent = <Check size={14} className="text-green-500" />; } 
        else if (evidenceFound.status === 'REJECTED') { cellBg = "bg-orange-50/50"; cellContent = <div className="p-1 bg-orange-100 rounded-full"><AlertCircle size={10} className="text-orange-600" /></div>; } 
        else { cellBg = "bg-blue-50/50"; cellContent = <Clock size={14} className="text-blue-500" />; }
      } else if (hasAnyPlannedInSpan) {
        if (isOverdue) { cellBg = "bg-red-50/30"; cellContent = <span className="text-red-400 font-bold text-xs">!</span>; } 
        else { cellBg = "bg-white"; cellContent = <span className="text-slate-200 font-bold text-[9px]">P</span>; }
      }
      cells.push(<td key={i} colSpan={colSpan} className={`border-r p-0 text-center transition-all relative group ${cellBg} border-slate-100 border-b h-10`}><div onClick={() => openModal(activity.id, interactionIndex)} className="w-full h-full flex items-center justify-center cursor-pointer hover:bg-slate-100/50 transition-colors">{cellContent}</div></td>);
      i += colSpan;
    }
    return cells;
  };

  const getMissingTasks = (activity: Activity) => {
    const plan = activity.plans?.[currentYear] || [];
    let planned = 0, approved = 0;
    if (plan.length > 0) {
      plan.forEach(m => { if (m.planned) { planned++; if (m.evidence?.status === 'APPROVED') approved++; } });
    } else {
      switch (activity.periodicity) {
        case Periodicity.MONTHLY: planned = 12; break;
        case Periodicity.BIMONTHLY: planned = 6; break;
        case Periodicity.QUARTERLY: planned = 4; break;
        case Periodicity.SEMIANNUAL: planned = 2; break;
        case Periodicity.ANNUAL: planned = 1; break;
        default: planned = 0;
      }
    }
    return { pending: planned - approved, approved, total: planned };
  };

  const activeActivity = activeActivityId ? activities.find(a => a.id === activeActivityId) : null;
  const activePlan = activeActivity && activeMonthIndex !== null ? (activeActivity.plans?.[currentYear] || [])[activeMonthIndex] : null;
  const activeEvidence = activePlan?.evidence || null;
  const isRejected = activeEvidence?.status === 'REJECTED';

  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadstart = () => setIsSaving(true);
      reader.onload = (event) => { if (event.target?.result) handleEvidenceSubmit('FILE', event.target.result as string, file.name); };
      reader.readAsDataURL(file);
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[calc(100vh-8rem)]">
      <div className="p-4 border-b border-slate-200 bg-white space-y-4 shrink-0">
        <div className="flex flex-col xl:flex-row xl:items-center justify-between gap-4">
          <div className="flex flex-wrap gap-3 items-center">
            <div className="flex items-center bg-slate-100 border border-slate-200 rounded-xl p-1 shadow-inner">
               <button onClick={() => setCurrentYear(2025)} className={`px-4 py-1.5 text-[11px] font-black rounded-lg transition-all ${currentYear === 2025 ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>2025</button>
               <button onClick={() => setCurrentYear(2026)} className={`px-4 py-1.5 text-[11px] font-black rounded-lg transition-all ${currentYear === 2026 ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>2026</button>
            </div>
            <select value={selectedPlant} onChange={(e) => setSelectedPlant(e.target.value)} className="bg-white px-3 py-2 border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-tight shadow-sm outline-none">
              <option value="ALL">TODAS LAS PLANTAS</option>
              {plants.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
            <select value={selectedArea} onChange={(e) => setSelectedArea(e.target.value)} className="bg-white px-3 py-2 border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-tight shadow-sm outline-none">
              <option value="ALL">TODAS LAS REAS</option>
              {areas.map(area => <option key={area.id} value={area.name}>{area.name}</option>)}
            </select>
          </div>
          <div className="flex gap-2 flex-wrap xl:flex-nowrap">
            <div className="flex items-center gap-2 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl"><ListChecks size={14} className="text-slate-500" /><div className="flex flex-col"><span className="text-[14px] font-black text-slate-800 leading-none">{stats.totalActive}</span><span className="text-[7px] font-bold text-slate-400 uppercase">Total Requisitos</span></div></div>
            <div className="flex items-center gap-2 px-3 py-2 bg-green-50 border border-green-100 rounded-xl"><Check size={14} className="text-green-600" /><div className="flex flex-col"><span className="text-[14px] font-black text-green-700 leading-none">{stats.approved}</span><span className="text-[7px] font-bold text-green-600 uppercase">Aprobados</span></div></div>
            <div className="flex items-center gap-2 px-3 py-2 bg-blue-50 border border-blue-100 rounded-xl"><Clock size={14} className="text-blue-600" /><div className="flex flex-col"><span className="text-[14px] font-black text-blue-700 leading-none">{stats.pending}</span><span className="text-[7px] font-bold text-blue-600 uppercase">Pendientes</span></div></div>
            <div className="flex items-center gap-2 px-3 py-2 bg-orange-50 border border-orange-100 rounded-xl"><AlertCircle size={14} className="text-orange-600" /><div className="flex flex-col"><span className="text-[14px] font-black text-orange-700 leading-none">{stats.rejected}</span><span className="text-[7px] font-bold text-orange-600 uppercase">Rechazados</span></div></div>
            <div className="flex items-center gap-2 px-3 py-2 bg-red-50 border border-red-100 rounded-xl"><ShieldAlert size={14} className="text-red-600" /><div className="flex flex-col"><span className="text-[14px] font-black text-red-700 leading-none">{stats.overdue}</span><span className="text-[7px] font-bold text-red-600 uppercase">Vencidos</span></div></div>
          </div>
        </div>
      </div>

      <div className="overflow-auto flex-1 scrollbar-thin">
        <table className="w-full text-[10px] text-left border-collapse table-fixed">
          <thead className="bg-slate-50 text-slate-400 font-black uppercase text-[9px] tracking-widest sticky top-0 z-10 shadow-sm border-b border-slate-200">
            <tr><th className="p-2 border-r w-12 text-center">Claus..</th><th className="p-2 border-r min-w-[150px]">Requisito</th><th className="p-2 border-r min-w-[180px]">Criterio Auditor铆a</th>{MONTHS.map(m => <th key={m} className="p-2 border-r text-center w-8">{m}</th>)}<th className="p-2 w-16 text-center sticky right-0 bg-slate-50 border-l">Avance</th></tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {filteredActivities.map((activity) => {
                const { pending, total, approved } = getMissingTasks(activity); const isReady = total > 0 && pending === 0;
                return (
                  <tr key={activity.id} className="hover:bg-slate-50/30 transition-colors h-10 group">
                    <td className="p-2 border-r border-slate-100 text-center font-black bg-white">{activity.subClause}</td>
                    <td className="p-2 border-r border-slate-100 bg-white"><div className="flex items-center justify-between"><div className="font-bold text-slate-800 text-[9px] leading-tight line-clamp-1">{activity.clauseTitle}</div><button onClick={() => openInfoModal(activity.id)} className="p-1 bg-slate-100 rounded hover:bg-red-600 hover:text-white transition-all ml-1 shrink-0 shadow-sm border border-slate-200" title="Ver m谩s detalles"><Eye size={12} /></button></div><div className="text-[7px] text-slate-400 font-black uppercase mt-0.5">{activity.responsibleArea}</div></td>
                    <td className="p-2 border-r border-slate-100 bg-white"><div className="text-slate-600 text-[9px] line-clamp-2 italic font-medium">"{activity.relatedQuestions}"</div></td>
                    {renderPeriodicityCells(activity)}
                    <td className="p-2 text-center sticky right-0 bg-white shadow-l border-l border-slate-100"><div className={`px-1 py-0.5 rounded text-[8px] font-black border ${isReady ? 'bg-green-50 text-green-600 border-green-200 shadow-sm' : 'bg-slate-50 text-slate-500 border-slate-100'}`}>{isReady ? 'LISTO' : `${approved}/${total}`}</div></td>
                  </tr>
                );
            })}
          </tbody>
        </table>
      </div>

      {modalOpen && activeActivity && activeMonthIndex !== null && (
        <div className="fixed inset-0 bg-slate-950/60 flex items-center justify-center z-[9999] p-4 backdrop-blur-sm animate-in fade-in duration-300">
          <div style={{ transform: `translate(${modalPos.x}px, ${modalPos.y}px)` }} className="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden border border-slate-200 relative animate-in zoom-in-95 duration-200">
            <div onMouseDown={handleMouseDown} className="p-5 bg-slate-900 text-white flex justify-between items-center shrink-0 cursor-move active:cursor-grabbing select-none">
              <div className="flex items-center"><div className="p-2.5 bg-red-600 rounded-2xl mr-4 shadow-lg shadow-red-900/40"><FileUp size={22} className="text-white" /></div><div><h3 className="text-sm font-black uppercase tracking-tight leading-none mb-1">Gesti贸n de Evidencia</h3><div className="flex items-center gap-2"><span className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">{MONTHS[activeMonthIndex]} {currentYear}</span><span className="w-1.5 h-1.5 bg-slate-700 rounded-full"></span><span className="text-[9px] text-red-400 font-black uppercase tracking-widest truncate max-w-[400px]">Numeral {activeActivity.subClause}: {activeActivity.clauseTitle}</span></div></div></div>
              <div className="flex items-center gap-2"><div className="p-2 bg-slate-800 rounded-xl text-slate-400 border border-slate-700/50 flex items-center gap-2"><Move size={14} /><span className="text-[8px] font-black uppercase tracking-widest hidden sm:inline">Mover</span></div><button onClick={() => setModalOpen(false)} className="p-2 hover:bg-red-600 transition-colors rounded-xl text-white/50 hover:text-white border border-transparent hover:border-red-400"><X size={20} /></button></div>
            </div>
            <div className="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-thin bg-slate-50/30">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div className="space-y-6">
                  <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm space-y-4">
                    <div className="flex items-center justify-between"><h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center"><Cloud size={14} className="mr-2 text-red-600" /> M茅todo de Entrega</h4><div className="flex bg-slate-100 p-1 rounded-xl border border-slate-200"><button onClick={() => setUploadTab('FILE')} className={`px-4 py-1.5 text-[9px] font-black rounded-lg transition-all ${uploadTab === 'FILE' ? 'bg-white text-slate-900 shadow-sm border border-slate-200' : 'text-slate-400 hover:text-slate-600'}`}>ARCHIVO</button><button onClick={() => setUploadTab('LINK')} className={`px-4 py-1.5 text-[9px] font-black rounded-lg transition-all ${uploadTab === 'LINK' ? 'bg-white text-slate-900 shadow-sm border border-slate-200' : 'text-slate-400 hover:text-slate-600'}`}>BIBLIOTECA</button></div></div>
                    {activeEvidence && !isRejected ? (
                      <div className="space-y-3"><div className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-200"><div className="flex items-center min-w-0">{activeEvidence.type === 'FILE' ? <FileText className="text-red-600 mr-3 shrink-0" size={24} /> : <Library className="text-purple-600 mr-3 shrink-0" size={24} />}<div className="min-w-0"><p className="text-[11px] font-black text-slate-800 truncate leading-none mb-1">{activeEvidence.fileName}</p><p className="text-[8px] text-slate-400 font-bold uppercase tracking-widest">Subido: {activeEvidence.uploadedAt.split(',')[0]}</p></div></div><div className="flex gap-2 shrink-0"><button onClick={() => openPreview(activeEvidence.url, activeEvidence.fileName)} className="p-2.5 bg-white hover:bg-slate-900 text-slate-600 hover:text-white rounded-xl transition-all shadow-sm border border-slate-200" title="Previsualizar"><Eye size={16} /></button><button onClick={() => window.open(activeEvidence.url, '_blank')} className="p-2.5 bg-white hover:bg-slate-900 text-slate-600 hover:text-white rounded-xl transition-all shadow-sm border border-slate-200" title="Enlace Externo"><ExternalLink size={16} /></button></div></div><div className={`p-4 rounded-2xl border-2 text-[10px] font-black uppercase text-center tracking-widest flex items-center justify-center gap-2 ${activeEvidence.status === 'APPROVED' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-blue-50 border-blue-200 text-blue-700'}`}>{activeEvidence.status === 'APPROVED' ? <CheckCircle size={14}/> : <Clock size={14}/>}Estado: {activeEvidence.status === 'APPROVED' ? 'APROBADO' : 'PENDIENTE'}</div></div>
                    ) : (
                      uploadTab === 'FILE' ? (
                        <div onClick={() => !isSaving && fileInputRef.current?.click()} className={`p-12 text-center border-3 border-dashed border-slate-200 rounded-[2rem] hover:bg-red-50/30 hover:border-red-400 transition-all cursor-pointer group bg-slate-50/50 ${isSaving ? 'opacity-50 cursor-wait' : ''}`}><input type="file" ref={fileInputRef} onChange={handleFileInputChange} className="hidden" />{isSaving ? <Loader2 size={40} className="mx-auto text-red-600 mb-4 animate-spin" /> : <Upload size={40} className="mx-auto text-slate-300 mb-4 group-hover:text-red-600 transition-transform group-hover:-translate-y-1" />}<p className="text-[10px] text-slate-400 font-black uppercase tracking-[0.2em] group-hover:text-red-700 leading-relaxed">{isSaving ? 'PROCESANDO...' : 'CLIC PARA ADJUNTAR EVIDENCIA'}</p><p className="text-[8px] text-slate-300 font-bold uppercase mt-2 tracking-widest">PDF, DOCX, PNG o XLSX</p></div>
                      ) : (
                        <div className="space-y-4"><div className="p-5 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner"><div className="flex items-center gap-3 mb-4"><div className="p-2 bg-purple-100 text-purple-600 rounded-xl shadow-sm"><Library size={20}/></div><span className="text-[10px] font-black uppercase tracking-widest text-slate-700">Biblioteca SIG Central</span></div><div className="space-y-3"><button onClick={() => setShowLibraryPicker(true)} className="w-full flex items-center justify-center gap-2 py-4 bg-purple-600 text-white text-[10px] font-black uppercase rounded-2xl shadow-lg shadow-purple-100 hover:bg-purple-700 transition-all active:scale-95"><Folder size={16} /> Explorar Directorio SIG</button><div className="relative flex items-center py-4"><div className="flex-grow border-t border-slate-200"></div><span className="flex-shrink mx-4 text-[8px] font-black text-slate-300 uppercase tracking-widest">v铆nculo manual</span><div className="flex-grow border-t border-slate-200"></div></div><input type="text" placeholder="URL del documento..." value={externalUrl} onChange={(e) => setExternalUrl(e.target.value)} className="w-full bg-white p-4 rounded-2xl border border-slate-200 text-[10px] font-bold outline-none focus:border-purple-500 shadow-sm" /><button onClick={() => externalUrl && handleEvidenceSubmit('LINK', externalUrl)} className="w-full py-3 bg-white text-slate-600 text-[9px] font-black uppercase rounded-xl border border-slate-200 hover:bg-slate-50 tracking-widest transition-colors">Vincular URL Manual</button></div></div></div>
                      )
                    )}
                  </div>
                  <div className="space-y-3">
                    <h4 className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center px-2"><History size={14} className="mr-2 text-slate-400" /> Historial de Revisiones</h4>
                    <div className="space-y-3 max-h-56 overflow-y-auto pr-3 scrollbar-thin">
                      {activeEvidence?.history?.map((log, idx) => (
                        <div key={idx} className="flex gap-4 text-[10px] p-4 bg-white rounded-2xl border border-slate-100 relative overflow-hidden shadow-sm group"><div className={`w-1.5 absolute left-0 top-0 h-full ${log.status === 'APPROVED' ? 'bg-green-500' : log.status === 'REJECTED' ? 'bg-orange-500' : 'bg-red-600'}`}></div><div className="flex-1 min-w-0"><div className="flex justify-between items-center mb-1.5"><span className="font-black text-slate-900 uppercase tracking-tight">{log.author}</span><span className="text-slate-400 text-[8px] font-bold">{log.date}</span></div><p className="text-slate-500 font-medium leading-relaxed italic border-l-2 border-slate-100 pl-3">"{log.text}"</p>{(log.fileUrl || (idx > 0 && activeEvidence?.url)) && (<div className="mt-3 pt-3 border-t border-slate-50 flex items-center gap-3"><button onClick={() => openPreview(log.fileUrl || activeEvidence!.url, log.fileName || activeEvidence!.fileName)} className="flex items-center gap-1.5 text-blue-600 hover:text-blue-800 font-black text-[9px] uppercase tracking-tighter transition-all"><Eye size={12} /> Previsualizar</button><button onClick={() => handleDownload(log.fileUrl || activeEvidence!.url, log.fileName || activeEvidence!.fileName)} className="flex items-center gap-1.5 text-slate-600 hover:text-slate-800 font-black text-[9px] uppercase tracking-tighter transition-all"><Download size={12} /> Descargar</button></div>)}</div></div>
                      ))}
                    </div>
                  </div>
                </div>
                <div className="bg-white p-8 rounded-[2.5rem] border border-slate-200 flex flex-col shadow-sm relative overflow-hidden"><div className="absolute top-0 right-0 w-24 h-24 bg-red-600/5 rounded-full -translate-y-12 translate-x-12"></div><div className="flex items-center gap-4 mb-8"><div className="p-3 bg-red-50 rounded-2xl border border-red-100 shadow-sm"><ShieldCheck size={24} className="text-red-600" /></div><div><h4 className="text-xs font-black text-slate-900 uppercase tracking-tight leading-none mb-1.5">Veredicto Auditor</h4><p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]">Criterio de Evaluaci贸n SIG</p></div></div><textarea value={adminComment} onChange={e => setAdminComment(e.target.value)} rows={8} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-5 text-[11px] font-bold text-slate-700 focus:border-red-600 focus:bg-white transition-all outline-none shadow-inner flex-1 resize-none mb-6 placeholder:text-slate-400" placeholder="Ingrese comentarios t茅cnicos..." /><div className="grid grid-cols-2 gap-4"><button onClick={() => handleAdminVerification('REJECTED')} className="py-5 bg-white hover:bg-orange-50 text-orange-700 rounded-2xl text-[10px] font-black uppercase border-2 border-orange-100 transition-all flex items-center justify-center gap-2 active:scale-95"><X size={18} /> Rechazar Hallazgo</button><button onClick={() => handleAdminVerification('APPROVED')} className="py-5 bg-slate-900 hover:bg-black text-white rounded-2xl text-[10px] font-black uppercase shadow-xl shadow-slate-200 transition-all flex items-center justify-center gap-2 active:scale-95"><BadgeCheck size={18} /> Validar Cumplimiento</button></div></div>
              </div>
            </div>
            <div className="p-6 bg-white border-t border-slate-100 flex justify-end gap-3 shrink-0"><button onClick={() => setModalOpen(false)} className="px-12 py-4 bg-slate-900 text-white rounded-2xl text-[11px] font-black uppercase tracking-[0.3em] shadow-xl hover:bg-black transition-all active:scale-95 flex items-center gap-3">Cerrar Consulta<ArrowRight size={16}/></button></div>
            {showLibraryPicker && (
              <div className="absolute inset-0 z-[10000] bg-white animate-in slide-in-from-bottom duration-300 flex flex-col">
                <div className="p-5 bg-slate-900 border-b flex justify-between items-center shrink-0"><div className="flex items-center gap-4"><div className="p-2.5 bg-purple-600 text-white rounded-2xl shadow-lg"><Library size={20}/></div><span className="text-sm font-black uppercase tracking-tight text-white">Biblioteca Central SIG</span></div><button onClick={() => setShowLibraryPicker(false)} className="p-3 hover:bg-slate-700 rounded-full text-white/50 hover:text-white transition-colors"><X size={20} /></button></div>
                <div className="flex-1 flex flex-col min-h-0"><div className="p-4 border-b flex gap-4 items-center shrink-0 bg-slate-50"><div className="relative flex-1"><Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={16} /><input type="text" placeholder="Buscar..." className="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-xs font-bold outline-none" /></div></div><div className="flex-1 overflow-y-auto p-6 scrollbar-thin bg-white"><div className="grid grid-cols-1 gap-2 max-w-4xl mx-auto">{currentFolderPath.length > 1 && (<div onClick={goBackLibrary} className="flex items-center p-4 text-purple-600 text-[11px] font-black uppercase hover:bg-purple-50 cursor-pointer rounded-2xl border-2 border-purple-100 mb-4 transition-all"><div className="p-2 bg-purple-100 rounded-xl mr-4"><ChevronLeft size={20} /></div>Nivel Superior</div>)}{getCurrentLibraryFiles().map(file => (<div key={file.id} onClick={() => selectLibraryFile(file)} className={`flex items-center justify-between p-5 border-2 border-transparent hover:border-purple-200 hover:bg-purple-50 cursor-pointer rounded-2xl transition-all group shadow-sm mb-2 ${file.type === 'folder' ? 'bg-slate-50' : 'bg-white'}`}><div className="flex items-center min-w-0"><div className={`p-3 rounded-2xl mr-5 shadow-sm transition-transform group-hover:scale-110 ${file.type === 'folder' ? 'bg-purple-600 text-white' : file.type === 'pdf' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>{file.type === 'folder' ? <Folder size={24} /> : <FileText size={24} />}</div><div className="min-w-0"><p className={`text-[12px] font-black uppercase tracking-tight group-hover:text-purple-700 truncate ${file.type === 'folder' ? 'text-purple-600' : 'text-slate-700'}`}>{file.name}</p><p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Versi贸n Actualizada  {file.size}</p></div></div><div className="flex items-center gap-3 shrink-0"><ArrowRight size={18} className="text-slate-200 group-hover:text-purple-500 transform translate-x-0 group-hover:translate-x-1 transition-all" /></div></div>))}</div></div></div>
              </div>
            )}
          </div>
        </div>
      )}
      
      {previewModalOpen && previewFile && (
        <div className="fixed inset-0 bg-slate-950/95 flex items-center justify-center z-[10001] p-4 backdrop-blur-xl animate-in fade-in duration-300">
           <div style={{ transform: `translate(${previewModalPos.x}px, ${previewModalPos.y}px)` }} className="bg-white rounded-[2rem] shadow-2xl w-[95%] max-w-5xl h-[85vh] flex flex-col overflow-hidden border border-white/10 animate-in zoom-in-95 duration-200">
              <div onMouseDown={handlePreviewMouseDown} className="p-5 bg-slate-900 text-white flex justify-between items-center shrink-0 border-b border-white/5 cursor-move active:cursor-grabbing select-none">
                 <div className="flex items-center gap-5"><div className="p-3 bg-blue-600 rounded-2xl shadow-xl shadow-blue-900/40 group"><Monitor size={22} className="text-white group-hover:scale-110 transition-transform" /></div><div className="min-w-0"><h3 className="text-sm font-black uppercase tracking-widest leading-none mb-1.5 flex items-center gap-2">Visor de Evidencia SIG <span className="text-[8px] bg-white/10 px-2 py-0.5 rounded border border-white/10 text-white/50 uppercase tracking-tighter">Renderizado Din谩mico HSEQ</span></h3><p className="text-[10px] text-slate-400 font-bold uppercase tracking-[0.15em] truncate max-w-[400px]">{previewFile.name}</p></div></div>
                 <div className="flex items-center gap-4"><button onClick={() => handleDownload(previewFile.url, previewFile.name)} className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-blue-900/30 active:scale-95"><Download size={16} /> Descargar Archivo</button><div className="w-px h-8 bg-white/10 mx-2"></div><button onClick={() => setPreviewModalOpen(false)} className="p-3 hover:bg-red-600 transition-colors rounded-2xl text-white/50 hover:text-white border border-transparent hover:border-red-400 active:scale-90"><X size={28} /></button></div>
              </div>
              <div className="flex-1 bg-slate-800 flex items-center justify-center relative overflow-hidden">
                 <div className="absolute inset-0 opacity-10 pointer-events-none bg-[radial-gradient(#ffffff_1px,transparent_1px)] [background-size:20px_20px]"></div>
                 <div className="w-full h-full flex flex-col items-center justify-center p-0">
                    {isPreviewLoading ? (
                      <div className="text-center space-y-4 animate-in fade-in duration-300"><Loader2 size={64} className="mx-auto text-blue-500 animate-spin" /><p className="text-xs font-black text-slate-400 uppercase tracking-[0.3em]">Preparando visualizaci贸n segura...</p></div>
                    ) : excelPreview ? (
                      <div className="w-full h-full bg-white overflow-auto p-10 scrollbar-thin animate-in slide-in-from-bottom-4 duration-500"><div className="flex items-center gap-3 mb-8 p-4 bg-green-50 text-green-700 border border-green-200 rounded-2xl max-w-fit shadow-sm"><TableProperties size={24} /><div><p className="text-[10px] font-black uppercase tracking-widest">Vista Interactiva Excel</p><p className="text-[8px] opacity-70 font-bold uppercase tracking-tighter">Hoja de C谩lculo SIG Corporativa</p></div></div><div className="overflow-x-auto shadow-2xl rounded-xl border border-slate-100" dangerouslySetInnerHTML={{ __html: excelPreview }} /></div>
                    ) : wordPreview ? (
                      <div className="w-full h-full bg-slate-100 overflow-auto p-10 scrollbar-thin animate-in slide-in-from-bottom-4 duration-500"><div className="flex items-center gap-3 mb-8 p-4 bg-blue-50 text-blue-700 border border-blue-200 rounded-2xl max-w-fit mx-auto shadow-sm"><FileText size={24} /><div><p className="text-[10px] font-black uppercase tracking-widest">Vista Previa de Documento Word</p><p className="text-[8px] opacity-70 font-bold uppercase tracking-tighter">Conversi贸n Din谩mica SIG-Reader</p></div></div><div className="shadow-2xl rounded-xl border border-slate-100" dangerouslySetInnerHTML={{ __html: wordPreview }} /></div>
                    ) : (previewFile.name.toLowerCase().endsWith('.pdf') || previewFile.url.startsWith('data:application/pdf')) ? (
                      <div className="w-full h-full relative flex items-center justify-center bg-slate-900/50"><embed src={previewFile.blobUrl} type="application/pdf" className="w-full h-full border-none shadow-2xl" /><div className="absolute top-4 left-4 bg-slate-900/60 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 opacity-0 hover:opacity-100 transition-opacity"><p className="text-[10px] text-white font-black uppercase tracking-widest">Navegaci贸n nativa PDF activa</p></div></div>
                    ) : (previewFile.name.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/) || previewFile.url.startsWith('data:image')) ? (
                      <div className="w-full h-full flex items-center justify-center p-8 overflow-auto"><img src={previewFile.blobUrl || previewFile.url} alt="Evidencia" className="max-w-full max-h-full object-contain rounded-xl shadow-2xl ring-4 ring-white/5 transition-transform hover:scale-[1.02]" /></div>
                    ) : (
                      <div className="text-center p-12 bg-white/5 rounded-[3rem] backdrop-blur-md border border-white/10 max-w-lg space-y-8">
                         <div className="p-8 bg-blue-600/20 text-blue-400 rounded-full inline-block mb-4 shadow-2xl">{previewFile.name.toLowerCase().endsWith('.pptx') ? <Layout size={80} /> : <FileSearch size={80} />}</div>
                         <div className="space-y-4">
                           <h4 className="text-2xl font-black text-white uppercase tracking-tight">{previewFile.name.toLowerCase().endsWith('.pptx') ? 'Presentaci贸n PowerPoint' : 'Formato Solo Descarga'}</h4>
                           <p className="text-xs text-slate-400 font-medium leading-relaxed">Este tipo de archivo requiere una aplicaci贸n externa para ser procesado manteniendo su integridad original o animaciones.</p>
                         </div>
                         <button onClick={() => handleDownload(previewFile.url, previewFile.name)} className="w-full py-5 bg-white text-slate-900 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-2xl hover:bg-slate-100 transition-all flex items-center justify-center gap-3"><Download size={20} /> Descargar Copia Local</button>
                      </div>
                    )}
                 </div>
              </div>
              <div className="p-4 bg-slate-900 border-t border-white/5 flex justify-center text-slate-500 overflow-hidden shrink-0"><p className="text-[10px] font-black uppercase tracking-[0.4em] animate-pulse">CONTROL DE SEGURIDAD INTEGRAL SIG  CENTRAL DE MADERAS</p></div>
           </div>
        </div>
      )}
      
      {infoModalOpen && activeActivity && (
        <div className="fixed inset-0 bg-slate-950/70 flex items-start justify-center z-[9999] p-4 pt-10 backdrop-blur-sm animate-in fade-in duration-300">
          <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col animate-in slide-in-from-top-4 duration-300 border border-slate-200 overflow-hidden">
             <div className="p-6 bg-[#1e293b] text-white flex justify-between items-center shrink-0">
                <div className="flex items-center"><div className="p-3 bg-red-600 rounded-xl mr-4 shadow-xl"><BookOpen size={24} className="text-white" /></div><div><h3 className="text-sm font-black leading-tight tracking-tight uppercase line-clamp-2">{activeActivity.clauseTitle}</h3><div className="flex gap-2 mt-2"><span className="text-[8px] font-black uppercase tracking-wider bg-blue-900/60 px-2 py-1 rounded border border-blue-700/50">Numeral: {activeActivity.subClause}</span><span className="text-[8px] font-black uppercase tracking-wider bg-slate-800 px-2 py-1 rounded border border-slate-700">{activeActivity.periodicity}</span></div></div></div>
                <button onClick={() => setInfoModalOpen(false)} className="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white"><X size={24} /></button>
             </div>
             <div className="p-6 space-y-6 overflow-y-auto scrollbar-thin flex-1">
                <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100 text-[11px] text-slate-600 leading-relaxed italic font-medium"><div className="flex items-center text-slate-400 font-black text-[9px] uppercase tracking-widest mb-3"><ShieldCheck size={14} className="mr-2" /> Descripci贸n</div>"{activeActivity.description}"</div>
                <div className="bg-blue-50/30 p-6 rounded-2xl border border-blue-100/50 text-[11px] text-slate-800 leading-relaxed font-semibold"><div className="flex items-center text-blue-600 font-black text-[9px] uppercase tracking-widest mb-3"><Target size={14} className="mr-2" /> Contexto Interno</div>{activeActivity.contextualization}</div>
                <div className="bg-orange-50/30 p-6 rounded-2xl border border-orange-100/50 text-[11px] text-orange-950 font-black"><div className="flex items-center text-orange-600 font-black text-[9px] uppercase tracking-widest mb-3"><BadgeCheck size={14} className="mr-2" /> Criterio de Auditor铆a</div>{activeActivity.relatedQuestions}</div>
             </div>
             <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-end"><button onClick={() => setInfoModalOpen(false)} className="px-8 py-3 bg-[#0f172a] text-white rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg flex items-center gap-2">Cerrar Consulta <ArrowRight size={14}/></button></div>
          </div>
        </div>
      )}
    </div>
  );
};
</file>

<file path="package.json">
{
  "name": "sig-manager-pro",
  "version": "1.6.9",
  "private": true,
  "type": "module",
  "engines": {
    "node": ">=20.0.0"
  },
  "scripts": {
    "dev": "npx serve .",
    "build": "./node_modules/esbuild/bin/esbuild index.tsx --bundle --outdir=dist --format=esm --jsx=automatic --minify --external:react --external:react-dom/* --external:lucide-react --external:recharts --external:firebase/* --external:xlsx --external:pdfjs-dist --external:mammoth && cp index.html metadata.json dist/ && node post-build.js",
    "start": "node server.js"
  },
  "dependencies": {
    "react": "19.0.0",
    "react-dom": "19.0.0",
    "lucide-react": "0.460.0",
    "recharts": "2.15.4",
    "firebase": "11.0.2",
    "express": "4.22.1",
    "esbuild": "0.24.2",
    "xlsx": "0.18.5",
    "pdfjs-dist": "4.10.38",
    "mammoth": "1.8.0",
    "serve": "14.2.3"
  },
  "devDependencies": {
    "typescript": "5.7.2"
  }
}
</file>

</files>
